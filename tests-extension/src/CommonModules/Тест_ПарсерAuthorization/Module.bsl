// Тест_ПарсерAuthorization

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("ПарсерAuthorization", "Security,Auth,Parser")
			// Успешные разборы
			.ДобавитьСерверныйТест("Разобрать_Bearer_Успех")
			.ДобавитьСерверныйТест("Разобрать_Basic_Успех")
			.ДобавитьСерверныйТест("Разобрать_PAT_Успех")
			.ДобавитьСерверныйТест("Разобрать_РегистрСхемы_Нормализуется")
			.ДобавитьСерверныйТест("Разобрать_ТабыМеняютсяНаПробелы_ИРазборРаботает")
			.ДобавитьСерверныйТест("Разобрать_ЛишниеПробелы_СхлопываютсяЧерезСокрЛП")

			// Ошибки формата (некорректный заголовок)
			.ДобавитьСерверныйТест("Разобрать_НетПробела_ИсключениеНекорректный")
			.ДобавитьСерверныйТест("Разобрать_ПустаяСхема_ИсключениеНекорректный")
			.ДобавитьСерверныйТест("Разобрать_ПустоеЗначение_ИсключениеНекорректный")
			.ДобавитьСерверныйТест("Разобрать_ТолькоПробелы_ИсключениеНекорректный")

			// Ошибка unsupported scheme
			.ДобавитьСерверныйТест("Разобрать_НеподдерживаемаяСхема_ИсключениеUnsupported")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 1) Успех
////////////////////////////////////////////////////////////////////////////////

Процедура Разобрать_Bearer_Успех() Экспорт
	Данные = ПарсерAuthorization.Разобрать("Bearer abc.def.ghi");

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("Bearer")
		.Свойство("Значение").Равно("abc.def.ghi");
КонецПроцедуры

Процедура Разобрать_Basic_Успех() Экспорт
	Данные = ПарсерAuthorization.Разобрать("Basic dGVzdDoxMjM=");

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("Basic")
		.Свойство("Значение").Равно("dGVzdDoxMjM=");
КонецПроцедуры

Процедура Разобрать_PAT_Успех() Экспорт
	Текст = "pat.11111111-1111-1111-1111-111111111111.abcdef";
	Данные = ПарсерAuthorization.Разобрать("PAT " + Текст);

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("PAT")
		.Свойство("Значение").Равно(Текст);
КонецПроцедуры

Процедура Разобрать_РегистрСхемы_Нормализуется() Экспорт
	Данные = ПарсерAuthorization.Разобрать("bEaReR token");

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("Bearer")
		.Свойство("Значение").Равно("token");
КонецПроцедуры

Процедура Разобрать_ТабыМеняютсяНаПробелы_ИРазборРаботает() Экспорт
	Текст = "Bearer" + Символы.Таб + "abc";
	Данные = ПарсерAuthorization.Разобрать(Текст);

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("Bearer")
		.Свойство("Значение").Равно("abc");
КонецПроцедуры

Процедура Разобрать_ЛишниеПробелы_СхлопываютсяЧерезСокрЛП() Экспорт
	// СокрЛП уберет лишние пробелы вокруг схемы/значения после выделения
	Данные = ПарсерAuthorization.Разобрать("   Bearer     abc   ");

	ЮТест.ОжидаетЧто(Данные)
		.Свойство("Схема").Равно("Bearer")
		.Свойство("Значение").Равно("abc");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 2) Некорректный заголовок
////////////////////////////////////////////////////////////////////////////////

Процедура Разобрать_НетПробела_ИсключениеНекорректный() Экспорт
	ЮТест.ОжидаетЧто(ПарсерAuthorization)
		.Метод("Разобрать", ЮТМетоды.МассивПараметров("Bearer"))
		.ВыбрасываетИсключение("некорректный заголовок Authorization");
КонецПроцедуры

Процедура Разобрать_ПустаяСхема_ИсключениеНекорректный() Экспорт
	// после trim строка начинается с пробела, схема пустая
	ЮТест.ОжидаетЧто(ПарсерAuthorization)
		.Метод("Разобрать", ЮТМетоды.МассивПараметров("   Bearer"))
		.ВыбрасываетИсключение("некорректный заголовок Authorization");
КонецПроцедуры

Процедура Разобрать_ПустоеЗначение_ИсключениеНекорректный() Экспорт
	ЮТест.ОжидаетЧто(ПарсерAuthorization)
		.Метод("Разобрать", ЮТМетоды.МассивПараметров("Bearer     "))
		.ВыбрасываетИсключение("некорректный заголовок Authorization");
КонецПроцедуры

Процедура Разобрать_ТолькоПробелы_ИсключениеНекорректный() Экспорт
	ЮТест.ОжидаетЧто(ПарсерAuthorization)
		.Метод("Разобрать", ЮТМетоды.МассивПараметров("    "))
		.ВыбрасываетИсключение("некорректный заголовок Authorization");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 3) Unsupported scheme
////////////////////////////////////////////////////////////////////////////////

Процедура Разобрать_НеподдерживаемаяСхема_ИсключениеUnsupported() Экспорт
	ЮТест.ОжидаетЧто(ПарсерAuthorization)
		.Метод("Разобрать", ЮТМетоды.МассивПараметров("Digest abc"))
		.ВыбрасываетИсключение("неподдерживаемая схема Authorization");
КонецПроцедуры
