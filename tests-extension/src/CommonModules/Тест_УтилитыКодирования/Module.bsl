Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты.ДобавитьТест("Кодирование_Base64_Пусто_Исключение");
	ЮТТесты.ДобавитьТест("Кодирование_Base64_Привет_UTF8_Декодируется");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_Пусто_Исключение");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_Остаток1_Исключение");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_Padding_Остаток2");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_Padding_Остаток3");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_ЗаменыИPadding_РеальныйПример");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_Декод_fo");

	// Эти два — по желанию (они сейчас зелёные, но ценность средняя)
	ЮТТесты.ДобавитьТест("Кодирование_Base64_ДефолтUTF8_ДекодируетПривет");
	ЮТТесты.ДобавитьТест("Кодирование_Base64Url_ДефолтUTF8_ДекодируетПривет");
	ЮТТесты.ДобавитьТест("Кодирование_Base64_ДекодВДвоичные_ПроверкаHex");
	ЮТТесты.ДобавитьТест("Кодирование_Base64_Декод_foo");
	
КонецПроцедуры

Процедура Кодирование_Base64_Пусто_Исключение() Экспорт
	ИсключениеСработало = Ложь;
	ТекстОшибки = "";

	Попытка
		УтилитыКодирования.Base64ДекодироватьВДвоичныеДанные("   ");
	Исключение
		ИсключениеСработало = Истина;
		ТекстОшибки = ОписаниеОшибки();
	КонецПопытки;

	ЮТест.ОжидаетЧто(ИсключениеСработало).Равно(Истина);
	ОжидатьЧтоСообщениеОшибкиСодержит(ТекстОшибки, "Некорректная Base64-строка: пустое значение.");
КонецПроцедуры

Процедура Кодирование_Base64_Привет_UTF8_Декодируется() Экспорт
	// base64("Привет" в UTF-8)
	СтрокаBase64 = "0J/RgNC40LLQtdGC";

	Факт = УтилитыКодирования.Base64ДекодироватьВСтроку(СтрокаBase64, КодировкаТекста.UTF8);
	ЮТест.ОжидаетЧто(Факт).Равно("Привет");
КонецПроцедуры

Процедура Кодирование_Base64Url_Остаток1_Исключение() Экспорт
	ИсключениеСработало = Ложь;
	ТекстОшибки = "";

	Попытка
		УтилитыКодирования.ПреобразоватьBase64UrlВBase64("A");
	Исключение
		ИсключениеСработало = Истина;
		ТекстОшибки = ОписаниеОшибки();
	КонецПопытки;

	ЮТест.ОжидаетЧто(ИсключениеСработало).Равно(Истина);
	ОжидатьЧтоСообщениеОшибкиСодержит(ТекстОшибки, "Некорректная Base64Url-строка: неверная длина.");
КонецПроцедуры

Процедура Кодирование_Base64Url_ЗаменыИPadding_РеальныйПример() Экспорт
	// "-_A" должен стать "+/A=" (и замены, и padding)
	Факт = УтилитыКодирования.ПреобразоватьBase64UrlВBase64("-_A");
	ЮТест.ОжидаетЧто(Факт).Равно("+/A=");
КонецПроцедуры

Процедура Кодирование_Base64Url_Декод_fo() Экспорт
	Факт = УтилитыКодирования.Base64UrlДекодироватьВСтроку("Zm8", КодировкаТекста.UTF8);
	ЮТест.ОжидаетЧто(Факт).Равно("fo");
КонецПроцедуры

Процедура Кодирование_Base64Url_Padding_Остаток2() Экспорт
	ЮТест.ОжидаетЧто(УтилитыКодирования.ПреобразоватьBase64UrlВBase64("Zg")).Равно("Zg==");
КонецПроцедуры

Процедура Кодирование_Base64Url_Padding_Остаток3() Экспорт
	ЮТест.ОжидаетЧто(УтилитыКодирования.ПреобразоватьBase64UrlВBase64("Zm8")).Равно("Zm8=");
КонецПроцедуры

Процедура Кодирование_Base64Url_Пусто_Исключение() Экспорт
	Искл = Ложь; Т = "";

	Попытка
		УтилитыКодирования.ПреобразоватьBase64UrlВBase64("   ");
	Исключение
		Искл = Истина;
		Т = ОписаниеОшибки();
	КонецПопытки;

	ЮТест.ОжидаетЧто(Искл).Равно(Истина);
	ОжидатьЧтоСообщениеОшибкиСодержит(Т, "Некорректная Base64Url-строка: пустое значение.");
КонецПроцедуры

Процедура Кодирование_Base64_ДекодВДвоичные_ПроверкаHex() Экспорт
	ДД = УтилитыКодирования.Base64ДекодироватьВДвоичныеДанные("/w==");
	ЮТест.ОжидаетЧто(ПолучитьHexСтрокуИзДвоичныхДанных(ДД)).Равно("FF");
КонецПроцедуры

Процедура Кодирование_Base64_Декод_foo() Экспорт
	Факт = УтилитыКодирования.Base64ДекодироватьВСтроку("Zm9v", КодировкаТекста.UTF8);
	ЮТест.ОжидаетЧто(Факт).Равно("foo");
КонецПроцедуры

Процедура Кодирование_Base64_ДефолтUTF8_ДекодируетПривет() Экспорт
	// base64("Привет" в UTF-8)
	СтрокаBase64 = "0J/RgNC40LLQtdGC";
	
	// ВАЖНО: вызываем БЕЗ второго параметра
	Факт = УтилитыКодирования.Base64ДекодироватьВСтроку(СтрокаBase64);
	
	ЮТест.ОжидаетЧто(Факт).Равно("Привет");
КонецПроцедуры

Процедура Кодирование_Base64Url_ДефолтUTF8_ДекодируетПривет() Экспорт
	// base64url = base64, только '/' заменяется на '_'
	СтрокаBase64Url = "0J_RgNC40LLQtdGC";
	
	// ВАЖНО: вызываем БЕЗ второго параметра
	Факт = УтилитыКодирования.Base64UrlДекодироватьВСтроку(СтрокаBase64Url);
	
	ЮТест.ОжидаетЧто(Факт).Равно("Привет");
КонецПроцедуры

Процедура ОжидатьЧтоСообщениеОшибкиСодержит(ТекстОшибки, Подстрока)
	ЮТест.ОжидаетЧто(Найти(ТекстОшибки, Подстрока) > 0).Равно(Истина);
КонецПроцедуры