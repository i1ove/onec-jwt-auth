// Тест_УтилитыJSON

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("УтилитыJSON", "Security,JSON")
			// JSONВСтруктуру
			.ДобавитьСерверныйТест("JSONВСтруктуру_Успех_ВозвращаетСтруктуру")
			.ДобавитьСерверныйТест("JSONВСтруктуру_ПустаяСтрока_Исключение")
			.ДобавитьСерверныйТест("JSONВСтруктуру_НевалидныйJSON_Исключение")

			// ВСтрокуJSON
			.ДобавитьСерверныйТест("ВСтрокуJSON_Успех_ВозвращаетНепустуюСтроку")

			// ПрочитатьСтроку
			.ДобавитьСерверныйТест("ПрочитатьСтроку_Успех_Тримит")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_НеСтруктура_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_НетПоля_НеОбязательное_Неопределено")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_НетПоля_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_ПолеНеопределено_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_ТипНеСтрока_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтроку_ПустаяПослеТрима_Обязательное_Исключение")

			// ПрочитатьЧисло
			.ДобавитьСерверныйТест("ПрочитатьЧисло_Успех")
			.ДобавитьСерверныйТест("ПрочитатьЧисло_ТипНеЧисло_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьЧисло_НетПоля_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьЧисло_ПолеНеопределено_Обязательное_Исключение")

			// ПрочитатьБулево
			.ДобавитьСерверныйТест("ПрочитатьБулево_Успех")
			.ДобавитьСерверныйТест("ПрочитатьБулево_ТипНеБулево_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьБулево_НетПоля_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьБулево_ПолеНеопределено_Обязательное_Исключение")

			// ПрочитатьМассивСтрок
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_Успех_НормализуетLowerИTrim")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_ТипНеМассив_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_ЭлементНеСтрока_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_ПустойМассив_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_НетПоля_НеОбязательное_Неопределено")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_НетПоля_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьМассивСтрок_ПолеНеопределено_Обязательное_Исключение")

			// ПрочитатьСтрокуИЛибоМассивСтрок
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_Успех_Строка")
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_Успех_Массив")
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_ТипНеСтрокаИНеМассив_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_ПустаяСтрока_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_НетПоля_Обязательное_Исключение")
			.ДобавитьСерверныйТест("ПрочитатьСтрокуИЛибоМассивСтрок_ПолеНеопределено_Обязательное_Исключение")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Helpers
////////////////////////////////////////////////////////////////////////////////

Функция ОбъектСПолем(Знач Имя, Знач Значение) Экспорт
	С = Новый Структура;
	С.Вставить(Имя, Значение);
	Возврат С;
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// 1) JSONВСтруктуру
////////////////////////////////////////////////////////////////////////////////

Процедура JSONВСтруктуру_Успех_ВозвращаетСтруктуру() Экспорт
	Стр = "{""a"":1,""b"":""x"",""c"":true,""arr"":[""q"",""w""]}";
	Рез = УтилитыJSON.JSONВСтруктуру(Стр);

	ЮТест.ОжидаетЧто(ТипЗнч(Рез)).Равно(Тип("Структура"));
	ЮТест.ОжидаетЧто(Рез).Свойство("a").Равно(1);
	ЮТест.ОжидаетЧто(Рез).Свойство("b").Равно("x");
	ЮТест.ОжидаетЧто(Рез).Свойство("c").Равно(Истина);
КонецПроцедуры

Процедура JSONВСтруктуру_ПустаяСтрока_Исключение() Экспорт
	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("JSONВСтруктуру", ЮТМетоды.МассивПараметров("   "))
		.ВыбрасываетИсключение("пустая строка");
КонецПроцедуры

Процедура JSONВСтруктуру_НевалидныйJSON_Исключение() Экспорт
	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("JSONВСтруктуру", ЮТМетоды.МассивПараметров("{""a"":}"))
		.ВыбрасываетИсключение("ошибка разбора");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 2) ВСтрокуJSON
////////////////////////////////////////////////////////////////////////////////

Процедура ВСтрокуJSON_Успех_ВозвращаетНепустуюСтроку() Экспорт
	С = Новый Структура("a,b", 1, "x");

	Стр = УтилитыJSON.ВСтрокуJSON(С);

	ЮТест.ОжидаетЧто(ТипЗнч(Стр)).Равно(Тип("Строка"));
	ЮТест.ОжидаетЧто(СтрДлина(СокрЛП(Стр)) > 0).ЭтоИстина();
	ЮТест.ОжидаетЧто(Стр).Содержит("""a""");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 3) ПрочитатьСтроку
////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьСтроку_Успех_Тримит() Экспорт
	Объект = ОбъектСПолем("name", "  Alice  ");

	Зн = УтилитыJSON.ПрочитатьСтроку(Объект, "name", Истина);

	ЮТест.ОжидаетЧто(Зн).Равно("Alice");
КонецПроцедуры

Процедура ПрочитатьСтроку_НеСтруктура_Исключение() Экспорт
	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтроку", ЮТМетоды.МассивПараметров("not-struct", "name", Ложь))
		.ВыбрасываетИсключение("ожидался объект");
КонецПроцедуры

Процедура ПрочитатьСтроку_НетПоля_НеОбязательное_Неопределено() Экспорт
	Объект = Новый Структура;
	Зн = УтилитыJSON.ПрочитатьСтроку(Объект, "name", Ложь);

	ЮТест.ОжидаетЧто(Зн).Равно(Неопределено);
КонецПроцедуры

Процедура ПрочитатьСтроку_НетПоля_Обязательное_Исключение() Экспорт
	Объект = Новый Структура;

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтроку", ЮТМетоды.МассивПараметров(Объект, "name", Истина))
		.ВыбрасываетИсключение("отсутствует обязательное поле 'name'");
КонецПроцедуры

Процедура ПрочитатьСтроку_ПолеНеопределено_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("name", Неопределено);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтроку", ЮТМетоды.МассивПараметров(Объект, "name", Истина))
		.ВыбрасываетИсключение("поле 'name' пустое");
КонецПроцедуры

Процедура ПрочитатьСтроку_ТипНеСтрока_Исключение() Экспорт
	Объект = ОбъектСПолем("name", 123);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтроку", ЮТМетоды.МассивПараметров(Объект, "name", Истина))
		.ВыбрасываетИсключение("должно быть строкой");
КонецПроцедуры

Процедура ПрочитатьСтроку_ПустаяПослеТрима_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("name", "   ");

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтроку", ЮТМетоды.МассивПараметров(Объект, "name", Истина))
		.ВыбрасываетИсключение("поле 'name' пустое");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 4) ПрочитатьЧисло
////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьЧисло_Успех() Экспорт
	Объект = ОбъектСПолем("age", 42);
	Зн = УтилитыJSON.ПрочитатьЧисло(Объект, "age", Истина);

	ЮТест.ОжидаетЧто(Зн).Равно(42);
КонецПроцедуры

Процедура ПрочитатьЧисло_ТипНеЧисло_Исключение() Экспорт
	Объект = ОбъектСПолем("age", "42");

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьЧисло", ЮТМетоды.МассивПараметров(Объект, "age", Истина))
		.ВыбрасываетИсключение("должно быть числом");
КонецПроцедуры

Процедура ПрочитатьЧисло_НетПоля_Обязательное_Исключение() Экспорт
	Объект = Новый Структура;

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьЧисло", ЮТМетоды.МассивПараметров(Объект, "age", Истина))
		.ВыбрасываетИсключение("отсутствует обязательное поле 'age'");
КонецПроцедуры

Процедура ПрочитатьЧисло_ПолеНеопределено_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("age", Неопределено);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьЧисло", ЮТМетоды.МассивПараметров(Объект, "age", Истина))
		.ВыбрасываетИсключение("поле 'age' пустое");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 5) ПрочитатьБулево
////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьБулево_Успех() Экспорт
	Объект = ОбъектСПолем("ok", Истина);
	Зн = УтилитыJSON.ПрочитатьБулево(Объект, "ok", Истина);

	ЮТест.ОжидаетЧто(Зн).Равно(Истина);
КонецПроцедуры

Процедура ПрочитатьБулево_ТипНеБулево_Исключение() Экспорт
	Объект = ОбъектСПолем("ok", "true");

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьБулево", ЮТМетоды.МассивПараметров(Объект, "ok", Истина))
		.ВыбрасываетИсключение("должно быть булевым");
КонецПроцедуры

Процедура ПрочитатьБулево_НетПоля_Обязательное_Исключение() Экспорт
	Объект = Новый Структура;

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьБулево", ЮТМетоды.МассивПараметров(Объект, "ok", Истина))
		.ВыбрасываетИсключение("отсутствует обязательное поле 'ok'");
КонецПроцедуры

Процедура ПрочитатьБулево_ПолеНеопределено_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("ok", Неопределено);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьБулево", ЮТМетоды.МассивПараметров(Объект, "ok", Истина))
		.ВыбрасываетИсключение("поле 'ok' пустое");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 6) ПрочитатьМассивСтрок
////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьМассивСтрок_Успех_НормализуетLowerИTrim() Экспорт
	Arr = Новый Массив;
	Arr.Добавить("  A  ");
	Arr.Добавить("b");
	Arr.Добавить(" Cc ");

	Объект = ОбъектСПолем("roles", Arr);
	Рез = УтилитыJSON.ПрочитатьМассивСтрок(Объект, "roles", Истина);

	ЮТест.ОжидаетЧто(Рез.Количество()).Равно(3);
	ЮТест.ОжидаетЧто(Рез[0]).Равно("a");
	ЮТест.ОжидаетЧто(Рез[1]).Равно("b");
	ЮТест.ОжидаетЧто(Рез[2]).Равно("cc");
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_ТипНеМассив_Исключение() Экспорт
	Объект = ОбъектСПолем("roles", "admin");

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "roles", Истина))
		.ВыбрасываетИсключение("должно быть массивом строк");
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_ЭлементНеСтрока_Исключение() Экспорт
	Arr = Новый Массив;
	Arr.Добавить("admin");
	Arr.Добавить(1);

	Объект = ОбъектСПолем("roles", Arr);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "roles", Истина))
		.ВыбрасываетИсключение("должен содержать строки");
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_ПустойМассив_Обязательное_Исключение() Экспорт
	Arr = Новый Массив;
	Объект = ОбъектСПолем("roles", Arr);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "roles", Истина))
		.ВыбрасываетИсключение("массив 'roles' пустой");
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_НетПоля_НеОбязательное_Неопределено() Экспорт
	Объект = Новый Структура;
	Рез = УтилитыJSON.ПрочитатьМассивСтрок(Объект, "roles", Ложь);

	ЮТест.ОжидаетЧто(Рез).Равно(Неопределено);
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_НетПоля_Обязательное_Исключение() Экспорт
	Объект = Новый Структура;

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "roles", Истина))
		.ВыбрасываетИсключение("отсутствует обязательное поле 'roles'");
КонецПроцедуры

Процедура ПрочитатьМассивСтрок_ПолеНеопределено_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("roles", Неопределено);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "roles", Истина))
		.ВыбрасываетИсключение("поле 'roles' пустое");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 7) ПрочитатьСтрокуИЛибоМассивСтрок
////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_Успех_Строка() Экспорт
	Объект = ОбъектСПолем("scope", "  Read  ");

	Рез = УтилитыJSON.ПрочитатьСтрокуИЛибоМассивСтрок(Объект, "scope", Истина);

	ЮТест.ОжидаетЧто(Рез).Равно("Read");
КонецПроцедуры

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_Успех_Массив() Экспорт
	Arr = Новый Массив;
	Arr.Добавить("  Read ");
	Arr.Добавить("WRITE");

	Объект = ОбъектСПолем("scope", Arr);

	Рез = УтилитыJSON.ПрочитатьСтрокуИЛибоМассивСтрок(Объект, "scope", Истина);

	ЮТест.ОжидаетЧто(ТипЗнч(Рез)).Равно(Тип("Массив"));
	ЮТест.ОжидаетЧто(Рез[0]).Равно("read");
	ЮТест.ОжидаетЧто(Рез[1]).Равно("write");
КонецПроцедуры

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_ТипНеСтрокаИНеМассив_Исключение() Экспорт
	Объект = ОбъектСПолем("scope", 123);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтрокуИЛибоМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "scope", Истина))
		.ВыбрасываетИсключение("должно быть строкой или массивом строк");
КонецПроцедуры

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_ПустаяСтрока_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("scope", "   ");

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтрокуИЛибоМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "scope", Истина))
		.ВыбрасываетИсключение("поле 'scope' пустое");
КонецПроцедуры

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_НетПоля_Обязательное_Исключение() Экспорт
	Объект = Новый Структура;

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтрокуИЛибоМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "scope", Истина))
		.ВыбрасываетИсключение("отсутствует обязательное поле 'scope'");
КонецПроцедуры

Процедура ПрочитатьСтрокуИЛибоМассивСтрок_ПолеНеопределено_Обязательное_Исключение() Экспорт
	Объект = ОбъектСПолем("scope", Неопределено);

	ЮТест.ОжидаетЧто(УтилитыJSON)
		.Метод("ПрочитатьСтрокуИЛибоМассивСтрок", ЮТМетоды.МассивПараметров(Объект, "scope", Истина))
		.ВыбрасываетИсключение("поле 'scope' пустое");
КонецПроцедуры
