// Тест_УтилитыСравнения

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("УтилитыСравнения", "Security,ConstantTime,Compare")
			.ДобавитьСерверныйТест("СравнитьКонстантно_РавныеСтроки_Истина")
			.ДобавитьСерверныйТест("СравнитьКонстантно_РазныеСтроки_Ложь")
			.ДобавитьСерверныйТест("СравнитьКонстантно_РазныеДлины_Ложь")
			.ДобавитьСерверныйТест("СравнитьКонстантно_ПустыеИНеопределено")
			.ДобавитьСерверныйТест("СравнитьКонстантно_НеСтроковыеТипы_ПриводятсяКСтроке")
			.ДобавитьСерверныйТест("СравнитьКонстантно_UTF8_НеASCII_Корректно")
			.ДобавитьСерверныйТест("СравнитьКонстантно_ДвоичныеДанные_Равны")
			.ДобавитьСерверныйТест("СравнитьКонстантно_ДвоичныеДанные_Различаются")
			.ДобавитьСерверныйТест("СравнитьКонстантно_СтрокаИДвоичныеДанные_Равны")
			.ДобавитьСерверныйТест("СравнитьКонстантно_СтрокаИДвоичныеДанные_Различаются")
			.ДобавитьСерверныйТест("СравнитьКонстантно_ОченьДлинныеСтроки_Работает")
			.ДобавитьСерверныйТест("СравнитьКонстантно_НулевыеБайты_ВUTF8_Работает")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Helpers
////////////////////////////////////////////////////////////////////////////////

Функция ДДИзСтрокиUTF8(Знач Текст) Экспорт
	Возврат ПолучитьДвоичныеДанныеИзСтроки(Текст, КодировкаТекста.UTF8, Ложь);
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// 1) Базовые свойства
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_РавныеСтроки_Истина() Экспорт
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("abc", "abc")).ЭтоИстина();
КонецПроцедуры

Процедура СравнитьКонстантно_РазныеСтроки_Ложь() Экспорт
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("abc", "abd")).ЭтоЛожь();
КонецПроцедуры

Процедура СравнитьКонстантно_РазныеДлины_Ложь() Экспорт
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("abc", "ab")).ЭтоЛожь();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("ab", "abc")).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 2) Неопределено / пустые
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_ПустыеИНеопределено() Экспорт
	// В коде: Неопределено -> ""
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Неопределено, Неопределено)).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("", Неопределено)).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Неопределено, "")).ЭтоИстина();

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("a", Неопределено)).ЭтоЛожь();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Неопределено, "a")).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 3) Не строковые типы приводятся к Строка()
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_НеСтроковыеТипы_ПриводятсяКСтроке() Экспорт
	// Число vs строка
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(123, "123")).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(123, "0123")).ЭтоЛожь();

	// Булево vs строка "Истина"/"Ложь" — зависит от Строка(Истина)
	// Проверяем консистентность: сравнение объекта с его Строка(объект) должно быть Истина
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Истина, Строка(Истина))).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Ложь, Строка(Ложь))).ЭтоИстина();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 4) UTF-8 / не ASCII
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_UTF8_НеASCII_Корректно() Экспорт
	// одинаковые кириллические строки
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("привет", "привет")).ЭтоИстина();
	// различие в одном символе
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("привет", "превет")).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 5) ДвоичныеДанные
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_ДвоичныеДанные_Равны() Экспорт
	ДД1 = ДДИзСтрокиUTF8("abc");
	ДД2 = ДДИзСтрокиUTF8("abc");

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(ДД1, ДД2)).ЭтоИстина();
КонецПроцедуры

Процедура СравнитьКонстантно_ДвоичныеДанные_Различаются() Экспорт
	ДД1 = ДДИзСтрокиUTF8("abc");
	ДД2 = ДДИзСтрокиUTF8("abd");

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(ДД1, ДД2)).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 6) Строка vs ДвоичныеДанные (должны сравниваться одинаково через UTF-8)
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_СтрокаИДвоичныеДанные_Равны() Экспорт
	Текст = "token-123";
	ДД = ДДИзСтрокиUTF8(Текст);

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(Текст, ДД)).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(ДД, Текст)).ЭтоИстина();
КонецПроцедуры

Процедура СравнитьКонстантно_СтрокаИДвоичныеДанные_Различаются() Экспорт
	ДД = ДДИзСтрокиUTF8("abc");

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно("abd", ДД)).ЭтоЛожь();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(ДД, "abd")).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 7) Длинные строки (проверка, что не падает и корректно работает)
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_ОченьДлинныеСтроки_Работает() Экспорт
	// 10k символов
	С1 = ПовторСтроки("a", 10000);
	С2 = ПовторСтроки("a", 9999) + "b";

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(С1, С1)).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(С1, С2)).ЭтоЛожь();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 8) Нулевые байты / спецсимволы в UTF-8
////////////////////////////////////////////////////////////////////////////////

Процедура СравнитьКонстантно_НулевыеБайты_ВUTF8_Работает() Экспорт
	// В 1С можно сформировать строку с NUL как Символ(0)
	С1 = "a" + Символ(0) + "b";
	С2 = "a" + Символ(0) + "b";
	С3 = "a" + Символ(0) + "c";

	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(С1, С2)).ЭтоИстина();
	ЮТест.ОжидаетЧто(УтилитыСравнения.СравнитьКонстантно(С1, С3)).ЭтоЛожь();
КонецПроцедуры

Функция ПовторСтроки(Знач Символ, Знач Количество) Экспорт
	Если Количество <= 0 Тогда
		Возврат "";
	КонецЕсли;

	Блок = Символ;
	Рез = "";

	К = Количество;
	Пока К > 0 Цикл
		Если (К % 2) = 1 Тогда
			Рез = Рез + Блок;
		КонецЕсли;
		К = Цел(К / 2);
		Если К > 0 Тогда
			Блок = Блок + Блок;
		КонецЕсли;
	КонецЦикла;

	Возврат Рез;
КонецФункции

