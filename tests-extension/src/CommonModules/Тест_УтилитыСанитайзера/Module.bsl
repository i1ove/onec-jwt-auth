// Тест_УтилитыСанитайзера

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("УтилитыСанитайзера", "Security,Sanitizer")
			// Базовая рекурсивная санитизация структур/массивов/соответствий
			.ДобавитьСерверныйТест("Структура_РедактируетЧувствительныеКлючи_ИРекурсивноВложенные")
			.ДобавитьСерверныйТест("Соответствие_РедактируетЧувствительныеКлючи")
			.ДобавитьСерверныйТест("ЧувствительныйКлюч_НеРазворачиваетВложенность")
			
			// Ограничители объема
			.ДобавитьСерверныйТест("Глубина_ОбрезаетTruncatedDepth_ПриМаксимумУровней1")
			.ДобавитьСерверныйТест("Массив_ОбрезаетTruncatedItemsКакЭлемент")
			.ДобавитьСерверныйТест("Структура_ОбрезаетTruncatedItemsЧерезКлюч")
			.ДобавитьСерверныйТест("Соответствие_ОбрезаетTruncatedItemsЧерезКлюч")

			// Строковые маскировки: PAT / Authorization / URL / JSON
			.ДобавитьСерверныйТест("PAT_МаскируетСекрет_СохраняяПунктуацию")
			.ДобавитьСерверныйТест("PAT_МаскируетВКонтекстеЧерезТочку")
			.ДобавитьСерверныйТест("PAT_НеМаскируетЕслиВнутриСлова")
			
			.ДобавитьСерверныйТест("Authorization_МаскируетBearer_ВМногострочномТексте")
			.ДобавитьСерверныйТест("Authorization_МаскируетСРазделителемРавно")
			.ДобавитьСерверныйТест("Authorization_БезРазделителя_УходитВFallback")
			
			.ДобавитьСерверныйТест("URL_МаскируетTokenИJSON_МаскируетTokenPassword")
			.ДобавитьСерверныйТест("URL_ПараметрAuthorization_ВсеЕщеМаскируется")
			.ДобавитьСерверныйТест("URL_НеМаскируетЕслиНеНачалоПараметра")

			.ДобавитьСерверныйТест("JSON_МаскируетТолькоСтроковыеЗначения")
			.ДобавитьСерверныйТест("JSON_НеЛомаетсяНаЭкранированныхКавычках")
			.ДобавитьСерверныйТест("JSON_КлючиНезависимыОтРегистра")

			// Ограничение длины строк и спец-типы
			.ДобавитьСерверныйТест("Строка_ОграничениеДлины_ДобавляетМаркерTruncated")
			.ДобавитьСерверныйТест("Строка_ОграничениеДлины_НеТрогаетКороткие")
			.ДобавитьСерверныйТест("ДвоичныеДанные_ПреобразуютсяВМаркерBinary")

			// Поведение на Неопределено
			.ДобавитьСерверныйТест("Строка_Неопределено_ВозвращаетПустуюСтроку")
			.ДобавитьСерверныйТест("Значение_Неопределено_ОстаетсяНеопределено")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 1) Санитизация структур/соответствий/массивов
////////////////////////////////////////////////////////////////////////////////

Процедура Структура_РедактируетЧувствительныеКлючи_ИРекурсивноВложенные() Экспорт
	Вход = Новый Структура;
	Вход.Вставить("authorization", "Bearer SECRET");
	Вход.Вставить("password", "qwerty");
	Вход.Вставить("safe", "ok");

	Влож = Новый Структура;
	Влож.Вставить("token", "abc");
	Влож.Вставить("x", "y");
	Вход.Вставить("nested", Влож);

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход);

	ЮТест.ОжидаетЧто(Рез)
		.Свойство("authorization").Равно("[REDACTED]")
		.Свойство("password").Равно("[REDACTED]")
		.Свойство("safe").Равно("ok")
		.Свойство("nested.token").Равно("[REDACTED]")
		.Свойство("nested.x").Равно("y");
КонецПроцедуры

Процедура Соответствие_РедактируетЧувствительныеКлючи() Экспорт
	Вход = Новый Соответствие;
	Вход.Вставить("secret", "123");
	Вход.Вставить("ok", "value");

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход);

	ЮТест.ОжидаетЧто(Рез)
		.Свойство("secret").Равно("[REDACTED]")
		.Свойство("ok").Равно("value");
КонецПроцедуры

Процедура ЧувствительныйКлюч_НеРазворачиваетВложенность() Экспорт
	Влож = Новый Структура("a", "b");
	Вход = Новый Структура("token", Влож);

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход);

	ЮТест.ОжидаетЧто(Рез).Свойство("token").Равно("[REDACTED]");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 2) Ограничители объема: depth / items
////////////////////////////////////////////////////////////////////////////////

Процедура Глубина_ОбрезаетTruncatedDepth_ПриМаксимумУровней1() Экспорт
	// a -> b -> c
	С = Новый Структура("c", 1);
	С2 = Новый Структура("b", С);
	С3 = Новый Структура("a", С2);

	// Уровень 0 допустим, уровень 1 уже режется
	Рез = УтилитыСанитайзера.СанитизироватьЗначение(С3, "Логи", 1, 100, 8000);

	ЮТест.ОжидаетЧто(Рез).Свойство("a").Равно("[TRUNCATED_DEPTH]");
КонецПроцедуры

Процедура Массив_ОбрезаетTruncatedItemsКакЭлемент() Экспорт
	Вход = Новый Массив;
	Вход.Добавить(1);
	Вход.Добавить(2);
	Вход.Добавить(3);
	Вход.Добавить(4);

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход, "Логи", 8, 3, 8000);

	ЮТест.ОжидаетЧто(Рез).ИмеетДлину(4);
	ЮТест.ОжидаетЧто(Рез[0]).Равно(1);
	ЮТест.ОжидаетЧто(Рез[1]).Равно(2);
	ЮТест.ОжидаетЧто(Рез[2]).Равно(3);
	ЮТест.ОжидаетЧто(Рез[3]).Равно("[TRUNCATED_ITEMS]");
КонецПроцедуры

Процедура Структура_ОбрезаетTruncatedItemsЧерезКлюч() Экспорт
	Вход = Новый Структура;
	Вход.Вставить("k1", 1);
	Вход.Вставить("k2", 2);
	Вход.Вставить("k3", 3);
	Вход.Вставить("k4", 4);

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход, "Логи", 8, 3, 8000);

	ЮТест.ОжидаетЧто(Рез).Свойство("_truncated").Равно("[TRUNCATED_ITEMS]");
	ЮТест.ОжидаетЧто(Рез).Свойство("k1").Равно(1);
	ЮТест.ОжидаетЧто(Рез).Свойство("k2").Равно(2);
	ЮТест.ОжидаетЧто(Рез).Свойство("k3").Равно(3);
КонецПроцедуры

Процедура Соответствие_ОбрезаетTruncatedItemsЧерезКлюч() Экспорт
	Вход = Новый Соответствие;
	Вход.Вставить("k1", 1);
	Вход.Вставить("k2", 2);
	Вход.Вставить("k3", 3);
	Вход.Вставить("k4", 4);

	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Вход, "Логи", 8, 3, 8000);

	ЮТест.ОжидаетЧто(Рез).Свойство("_truncated").Равно("[TRUNCATED_ITEMS]");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 3) PAT
////////////////////////////////////////////////////////////////////////////////

Процедура PAT_МаскируетСекрет_СохраняяПунктуацию() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Текст = "user token = pat." + UUID + ".abcdef.";

	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно("user token = pat." + UUID + ".[REDACTED].");
КонецПроцедуры

Процедура PAT_МаскируетВКонтекстеЧерезТочку() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Текст = "compat.pat." + UUID + ".abcdef";

	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно("compat.pat." + UUID + ".[REDACTED]");
КонецПроцедуры

Процедура PAT_НеМаскируетЕслиВнутриСлова() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Текст = "compatpat." + UUID + ".abcdef"; // слева буква => пропуск

	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно(Текст);
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 4) Authorization
////////////////////////////////////////////////////////////////////////////////

Процедура Authorization_МаскируетBearer_ВМногострочномТексте() Экспорт
	Текст = "Authorization: Bearer abc" + Символы.ВК + Символы.ПС
		+ "X-Header: 1";

	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	Ожид = "Authorization: Bearer [REDACTED]" + Символы.ПС + "X-Header: 1";
	ЮТест.ОжидаетЧто(Рез).Равно(Ожид);
КонецПроцедуры

Процедура Authorization_МаскируетСРазделителемРавно() Экспорт
	Текст = "Authorization=Bearer abc";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно("Authorization= Bearer [REDACTED]");
КонецПроцедуры

Процедура Authorization_БезРазделителя_УходитВFallback() Экспорт
	Текст = "Authorization Bearer abc";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно("Authorization: [REDACTED]");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 5) URL + JSON
////////////////////////////////////////////////////////////////////////////////

Процедура URL_МаскируетTokenИJSON_МаскируетTokenPassword() Экспорт
	Текст =
		"https://ex/a?token=abc&x=1 " +
		"{""token"":""abc"",""nested"":{""password"":""p""}}";

	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Содержит("token=[REDACTED]");
	ЮТест.ОжидаетЧто(Рез).Содержит("""token"":""[REDACTED]""");
	ЮТест.ОжидаетЧто(Рез).Содержит("""password"":""[REDACTED]""");
КонецПроцедуры

Процедура URL_ПараметрAuthorization_ВсеЕщеМаскируется() Экспорт
	Текст = "https://ex/a?authorization=Bearer%20abc&x=1";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Содержит("authorization=[REDACTED]&x=1");
	ЮТест.ОжидаетЧто(Рез).НеСодержит("abc");
КонецПроцедуры

Процедура URL_НеМаскируетЕслиНеНачалоПараметра() Экспорт
	Текст = "mytoken=abc&x=1";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Равно(Текст);
КонецПроцедуры

Процедура JSON_МаскируетТолькоСтроковыеЗначения() Экспорт
	Текст = "{""token"":""abc"",""secret"":123,""password"":""p""}";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Содержит("""token"":""[REDACTED]""");
	ЮТест.ОжидаетЧто(Рез).Содержит("""password"":""[REDACTED]""");
	// secret не строка => не маскируется
	ЮТест.ОжидаетЧто(Рез).Содержит("""secret"":123");
КонецПроцедуры

Процедура JSON_НеЛомаетсяНаЭкранированныхКавычках() Экспорт
	Текст = "{""token"":""a\""b\""c"",""password"":""p""}";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Содержит("""token"":""[REDACTED]""");
	ЮТест.ОжидаетЧто(Рез).Содержит("""password"":""[REDACTED]""");
КонецПроцедуры

Процедура JSON_КлючиНезависимыОтРегистра() Экспорт
	Текст = "{""ToKeN"":""abc"",""PaSsWoRd"":""p""}";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 8000);

	ЮТест.ОжидаетЧто(Рез).Содержит("""ToKeN"":""[REDACTED]""");
	ЮТест.ОжидаетЧто(Рез).Содержит("""PaSsWoRd"":""[REDACTED]""");
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 6) Длина строки + спец-типы
////////////////////////////////////////////////////////////////////////////////

Процедура Строка_ОграничениеДлины_ДобавляетМаркерTruncated() Экспорт
	Текст = "0123456789ABCDEFGHIJ"; // 20
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 10);

	ЮТест.ОжидаетЧто(Лев(Рез, 10)).Равно("0123456789");
	ЮТест.ОжидаетЧто(Рез).Содержит("...[TRUNCATED]");
	ЮТест.ОжидаетЧто(Прав(Рез, СтрДлина("...[TRUNCATED]"))).Равно("...[TRUNCATED]");
КонецПроцедуры

Процедура Строка_ОграничениеДлины_НеТрогаетКороткие() Экспорт
	Текст = "short";
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Текст, 10);

	ЮТест.ОжидаетЧто(Рез).Равно("short");
	ЮТест.ОжидаетЧто(Рез).НеСодержит("[TRUNCATED]");
КонецПроцедуры

Процедура ДвоичныеДанные_ПреобразуютсяВМаркерBinary() Экспорт
	ИмяФайла = ПолучитьИмяВременногоФайла();

	Попытка
		ТекстовыйДок = Новый ТекстовыйДокумент;
		ТекстовыйДок.УстановитьТекст("abcd");
		ТекстовыйДок.Записать(ИмяФайла);

		Бин = Новый ДвоичныеДанные(ИмяФайла);
		Рез = УтилитыСанитайзера.СанитизироватьЗначение(Бин);

		ЮТест.ОжидаетЧто(Рез).Равно("[BINARY]");
	Исключение
		// гарантируем очистку файла
		УдалитьФайлы(ИмяФайла);
		ВызватьИсключение;
	КонецПопытки;

	УдалитьФайлы(ИмяФайла);
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// 7) Неопределено
////////////////////////////////////////////////////////////////////////////////

Процедура Строка_Неопределено_ВозвращаетПустуюСтроку() Экспорт
	Рез = УтилитыСанитайзера.СанитизироватьСтроку(Неопределено, 8000);
	ЮТест.ОжидаетЧто(Рез).Равно("");
КонецПроцедуры

Процедура Значение_Неопределено_ОстаетсяНеопределено() Экспорт
	Рез = УтилитыСанитайзера.СанитизироватьЗначение(Неопределено);
	ЮТест.ОжидаетЧто(Рез).Равно(Неопределено);
КонецПроцедуры
