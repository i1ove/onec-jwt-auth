// Общий модуль: Тест_Basic_Логика
// Свойства: Сервер = Истина, Глобальный = Ложь

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("Basic_Логика.РазобратьBasic")
			.ДобавитьТест("Basic_Base64Пусто_Исключение")
			.ДобавитьТест("Basic_НетДвоеточия_Исключение")
			.ДобавитьТест("Basic_ПустойЛогин_Исключение")
			.ДобавитьТест("Basic_ПустойПароль_Разбирается")
			.ДобавитьТест("Basic_ТримЛогинаИПароля_Успех")
			.ДобавитьТест("Basic_ВнутренниеПробелыВПароле_Сохраняются")
			.ДобавитьТест("Basic_ПарольМожетСодержатьДвоеточия");
КонецПроцедуры

// ---------------------------
// Хелперы
// ---------------------------

Процедура ОжидатьИсключениеСПодстрокой(Знач ЗначениеBase64, Знач ОжидаемаяПодстрока) Экспорт
	Искл = Ложь;
	Текст = "";

	Попытка
		Basic_Логика.РазобратьBasic(ЗначениеBase64);
	Исключение
		Искл = Истина;
		Текст = ОписаниеОшибки();
	КонецПопытки;

	ЮТест.ОжидаетЧто(Искл).Равно(Истина);

	Если НЕ ПустаяСтрока(ОжидаемаяПодстрока) Тогда
		ЮТест.ОжидаетЧто(Найти(НРег(Текст), НРег(ОжидаемаяПодстрока)) > 0).Равно(Истина);
	КонецЕсли;
КонецПроцедуры

Функция Base64ИзUTF8Строки(Знач Текст) Экспорт
	ДД = ПолучитьДвоичныеДанныеИзСтроки(Текст, КодировкаТекста.UTF8);
	Возврат Base64Строка(ДД);
КонецФункции

// ---------------------------
// Тесты
// ---------------------------

Процедура Basic_Base64Пусто_Исключение() Экспорт
	// Тут исключение кидает УтилитыКодирования (у вас оно стабильно на пустых/пробельных)
	ОжидатьИсключениеСПодстрокой("   ", "Base64");
КонецПроцедуры

Процедура Basic_НетДвоеточия_Исключение() Экспорт
	ЗначениеBase64 = Base64ИзUTF8Строки("loginpassword");
	ОжидатьИсключениеСПодстрокой(ЗначениеBase64, "Некорректный формат Basic");
КонецПроцедуры

Процедура Basic_ПустойЛогин_Исключение() Экспорт
	ЗначениеBase64 = Base64ИзUTF8Строки(":pass");
	ОжидатьИсключениеСПодстрокой(ЗначениеBase64, "пустой логин в Basic");
КонецПроцедуры

Процедура Basic_ПустойПароль_Разбирается() Экспорт
    ЗначениеBase64 = Base64ИзUTF8Строки("login:");

    Результат = Basic_Логика.РазобратьBasic(ЗначениеBase64);

    ЮТест.ОжидаетЧто(Результат).Свойство("Логин").Равно("login");
    ЮТест.ОжидаетЧто(Результат).Свойство("Пароль").Равно(""); // теперь это валидно
КонецПроцедуры

Процедура Basic_ТримЛогинаИПароля_Успех() Экспорт
	ЗначениеBase64 = Base64ИзUTF8Строки("  login  :  pass  ");

	Рез = Basic_Логика.РазобратьBasic(ЗначениеBase64);

	ЮТест.ОжидаетЧто(ТипЗнч(Рез)).Равно(Тип("Структура"));
	ЮТест.ОжидаетЧто(Рез.Логин).Равно("login");
	ЮТест.ОжидаетЧто(Рез.Пароль).Равно("pass");
КонецПроцедуры

Процедура Basic_ВнутренниеПробелыВПароле_Сохраняются() Экспорт
	ЗначениеBase64 = Base64ИзUTF8Строки("login: pa ss ");

	Рез = Basic_Логика.РазобратьBasic(ЗначениеBase64);

	ЮТест.ОжидаетЧто(Рез.Логин).Равно("login");
	ЮТест.ОжидаетЧто(Рез.Пароль).Равно("pa ss");
КонецПроцедуры

Процедура Basic_ПарольМожетСодержатьДвоеточия() Экспорт
	ЗначениеBase64 = Base64ИзUTF8Строки("login:pa:ss:more");

	Рез = Basic_Логика.РазобратьBasic(ЗначениеBase64);

	ЮТест.ОжидаетЧто(Рез.Логин).Равно("login");
	ЮТест.ОжидаетЧто(Рез.Пароль).Равно("pa:ss:more");
КонецПроцедуры
