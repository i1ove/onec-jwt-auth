// Тест_PAT_Логика

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("PAT_Логика", "Security,PAT")
			// РазобратьPAT - позитив
			.ДобавитьСерверныйТест("РазобратьPAT_КорректныйPAT_ВозвращаетUUIDИLowerSecret")
			.ДобавитьСерверныйТест("РазобратьPAT_ТримИРегистрПрефиксаДопустимы")

			// РазобратьPAT - ошибки формата
			.ДобавитьСерверныйТест("РазобратьPAT_ПустаяСтрока_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_НеверноеКоличествоЧастей_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_НеверныйПрефикс_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_НетUUID_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_НетSecret_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_UUIDНеUUID_ВыбрасываетИсключение")
			.ДобавитьСерверныйТест("РазобратьPAT_SecretНеHex_ВыбрасываетИсключение")

			// ЭтоHexСтрока
			.ДобавитьСерверныйТест("ЭтоHexСтрока_КорректнаяLower_Истина")
			.ДобавитьСерверныйТест("ЭтоHexСтрока_КорректнаяUpper_Истина")
			.ДобавитьСерверныйТест("ЭтоHexСтрока_Пустая_Ложь")
			.ДобавитьСерверныйТест("ЭтоHexСтрока_НедопустимыеСимволы_Ложь")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// РазобратьPAT
////////////////////////////////////////////////////////////////////////////////

Процедура РазобратьPAT_КорректныйPAT_ВозвращаетUUIDИLowerSecret() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Вход = "pat." + UUID + ".ABCDEF"; // upper secret -> должен стать lower

	Рез = PAT_Логика.РазобратьPAT(Вход);

	ЮТест.ОжидаетЧто(Рез)
		.Свойство("Secret").Равно("abcdef")
		.Свойство("ИдентификаторТокена").Равно(Новый УникальныйИдентификатор(UUID))
	;
КонецПроцедуры

Процедура РазобратьPAT_ТримИРегистрПрефиксаДопустимы() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Вход = "   PAT." + UUID + ".a1b2c3   ";

	Рез = PAT_Логика.РазобратьPAT(Вход);

	ЮТест.ОжидаетЧто(Рез)
		.Свойство("Secret").Равно("a1b2c3")
		.Свойство("ИдентификаторТокена").Равно(Новый УникальныйИдентификатор(UUID))
	;
КонецПроцедуры

Процедура РазобратьPAT_ПустаяСтрока_ВыбрасываетИсключение() Экспорт
	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров("   "))
		.ВыбрасываетИсключение("пустой PAT")
	;
КонецПроцедуры

Процедура РазобратьPAT_НеверноеКоличествоЧастей_ВыбрасываетИсключение() Экспорт
	// 2 части
	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров("pat.11111111-1111-1111-1111-111111111111"))
		.ВыбрасываетИсключение("некорректный формат PAT")
	;

	// 4 части
	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров("pat.11111111-1111-1111-1111-111111111111.aa.bb"))
		.ВыбрасываетИсключение("некорректный формат PAT")
	;
КонецПроцедуры

Процедура РазобратьPAT_НеверныйПрефикс_ВыбрасываетИсключение() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Вход = "tok." + UUID + ".abcdef";

	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров(Вход))
		.ВыбрасываетИсключение("некорректный префикс PAT")
	;
КонецПроцедуры

Процедура РазобратьPAT_НетUUID_ВыбрасываетИсключение() Экспорт
	// pat..abcdef => UUID пустой
	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров("pat..abcdef"))
		.ВыбрасываетИсключение("отсутствует идентификатор PAT")
	;
КонецПроцедуры

Процедура РазобратьPAT_НетSecret_ВыбрасываетИсключение() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";

	// pat.<uuid>. => secret пустой
	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров("pat." + UUID + "."))
		.ВыбрасываетИсключение("отсутствует секрет PAT")
	;
КонецПроцедуры

Процедура РазобратьPAT_UUIDНеUUID_ВыбрасываетИсключение() Экспорт
	Вход = "pat.NOT-A-UUID.abcdef";

	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров(Вход))
		.ВыбрасываетИсключение("идентификатор PAT не является UUID")
	;
КонецПроцедуры

Процедура РазобратьPAT_SecretНеHex_ВыбрасываетИсключение() Экспорт
	UUID = "11111111-1111-1111-1111-111111111111";
	Вход = "pat." + UUID + ".abcg"; // g не hex

	ЮТест.ОжидаетЧто(PAT_Логика)
		.Метод("РазобратьPAT", ЮТМетоды.МассивПараметров(Вход))
		.ВыбрасываетИсключение("секрет PAT должен быть hex-строкой")
	;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ЭтоHexСтрока
////////////////////////////////////////////////////////////////////////////////

Процедура ЭтоHexСтрока_КорректнаяLower_Истина() Экспорт
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("deadbeef")).ЭтоИстина();
КонецПроцедуры

Процедура ЭтоHexСтрока_КорректнаяUpper_Истина() Экспорт
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("DEADBEEF")).ЭтоИстина();
КонецПроцедуры

Процедура ЭтоHexСтрока_Пустая_Ложь() Экспорт
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("")).ЭтоЛожь();
КонецПроцедуры

Процедура ЭтоHexСтрока_НедопустимыеСимволы_Ложь() Экспорт
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("abcg")).ЭтоЛожь();   // g
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("ab cd")).ЭтоЛожь();  // пробел
	ЮТест.ОжидаетЧто(PAT_Логика.ЭтоHexСтрока("ab-cd")).ЭтоЛожь();  // дефис
КонецПроцедуры
