// Общий модуль: Тест_JWT_Логика
// Свойства: Сервер = Истина, Глобальный = Ложь

Процедура ИсполняемыеСценарии() Экспорт
	ЮТТесты
		.ДобавитьТестовыйНабор("JWT_Логика.РазобратьJWT")
			.ДобавитьТест("JWT_ПустаяСтрока_Исключение")
			.ДобавитьТест("JWT_Не3Части_Исключение")
			.ДобавитьТест("JWT_ПустаяЧасть_Исключение")
			.ДобавитьТест("JWT_HeaderНеBase64Url_Исключение")
			.ДобавитьТест("JWT_PayloadНеBase64Url_Исключение")
			.ДобавитьТест("JWT_HeaderНевалидныйJSON_Исключение")
			.ДобавитьТест("JWT_HeaderНеОбъект_Исключение")
			.ДобавитьТест("JWT_PayloadНеОбъект_Исключение")
			.ДобавитьТест("JWT_МинимальныйУспех_ПоляНеопределены")
			.ДобавитьТест("JWT_Claims_ПолныйНабор_AudСтрока")
			.ДобавитьТест("JWT_Claims_ПолныйНабор_AudМассив");
КонецПроцедуры

// ---------------------------
// Хелперы
// ---------------------------

Процедура ОжидатьИсключениеСПодстрокой(ВыполнитьРазборКакСтроку, ОжидаемаяПодстрока) Экспорт
	// ВыполнитьРазборКакСтроку — уже готовая compact JWT строка
	Искл = Ложь;
	Текст = "";

	Попытка
		JWT_Логика.РазобратьJWT(ВыполнитьРазборКакСтроку);
	Исключение
		Искл = Истина;
		Текст = ОписаниеОшибки();
	КонецПопытки;

	ЮТест.ОжидаетЧто(Искл).Равно(Истина);

	Если НЕ ПустаяСтрока(ОжидаемаяПодстрока) Тогда
		ЮТест.ОжидаетЧто(Найти(Текст, ОжидаемаяПодстрока) > 0).Равно(Истина);
	КонецЕсли;
КонецПроцедуры

Функция Base64UrlИзUTF8Строки(Знач Текст) Экспорт
	ДД = ПолучитьДвоичныеДанныеИзСтроки(Текст, КодировкаТекста.UTF8);
	// Стандартная Base64-строка
	B64 = Base64Строка(ДД);
	// Превращаем в Base64Url: + -> -, / -> _, убираем =
	B64Url = СтрЗаменить(B64, "+", "-");
	B64Url = СтрЗаменить(B64Url, "/", "_");
	Пока СтрЗаканчиваетсяНа(B64Url, "=") Цикл
		B64Url = Лев(B64Url, СтрДлина(B64Url) - 1);
	КонецЦикла;
	Возврат B64Url;
КонецФункции

Функция СобратьJWT(Знач HeaderJSON, Знач PayloadJSON, Знач SignatureТекст = "sig") Экспорт
	HeaderPart = Base64UrlИзUTF8Строки(HeaderJSON);
	PayloadPart = Base64UrlИзUTF8Строки(PayloadJSON);
	SignaturePart = Base64UrlИзUTF8Строки(SignatureТекст); // главное — непустая часть
	Возврат HeaderPart + "." + PayloadPart + "." + SignaturePart;
КонецФункции

// ---------------------------
// Тесты: ошибки формата
// ---------------------------

Процедура JWT_ПустаяСтрока_Исключение() Экспорт
	ОжидатьИсключениеСПодстрокой("   ", "Некорректный JWT: пустая строка.");
КонецПроцедуры

Процедура JWT_Не3Части_Исключение() Экспорт
	ОжидатьИсключениеСПодстрокой("a.b", "Некорректный JWT: ожидались 3 части");
	ОжидатьИсключениеСПодстрокой("a.b.c.d", "Некорректный JWT: ожидались 3 части");
КонецПроцедуры

Процедура JWT_ПустаяЧасть_Исключение() Экспорт
	ОжидатьИсключениеСПодстрокой("a..c", "Некорректный JWT: пустая часть.");
	ОжидатьИсключениеСПодстрокой(".b.c", "Некорректный JWT: пустая часть.");
	ОжидатьИсключениеСПодстрокой("a.b.", "Некорректный JWT: пустая часть.");
КонецПроцедуры

// ---------------------------
// Тесты: decode/JSON/тип
// ---------------------------

Процедура JWT_HeaderНеBase64Url_Исключение() Экспорт
	// Header часть заведомо не base64url (символы пробела и '*')
	Компакт = "a* a." + Base64UrlИзUTF8Строки("{}") + "." + Base64UrlИзUTF8Строки("sig");
	ОжидатьИсключениеСПодстрокой(Компакт, "Base64");
КонецПроцедуры

Процедура JWT_PayloadНеBase64Url_Исключение() Экспорт
	Компакт = Base64UrlИзUTF8Строки("{}") + ".a* a." + Base64UrlИзUTF8Строки("sig");
	ОжидатьИсключениеСПодстрокой(Компакт, "Base64");
КонецПроцедуры

Процедура JWT_HeaderНевалидныйJSON_Исключение() Экспорт
	Компакт = СобратьJWT("{", "{}", "sig"); // "{" невалидный JSON
	ОжидатьИсключениеСПодстрокой(Компакт, "JSON"); // сообщение зависит от JSONВСтруктуру, проверяем по подстроке
КонецПроцедуры

Процедура JWT_HeaderНеОбъект_Исключение() Экспорт
	Компакт = СобратьJWT("[]", "{}", "sig"); // header JSON-массив, не объект
	ОжидатьИсключениеСПодстрокой(Компакт, "Некорректный JWT: header должен быть JSON-объектом.");
КонецПроцедуры

Процедура JWT_PayloadНеОбъект_Исключение() Экспорт
	Компакт = СобратьJWT("{}", "[]", "sig");
	ОжидатьИсключениеСПодстрокой(Компакт, "Некорректный JWT: payload должен быть JSON-объектом.");
КонецПроцедуры

// ---------------------------
// Тесты: успех
// ---------------------------

Процедура JWT_МинимальныйУспех_ПоляНеопределены() Экспорт
	Компакт = СобратьJWT("{}", "{}", "sig");

	Рез = JWT_Логика.РазобратьJWT(Компакт);

	ЮТест.ОжидаетЧто(ТипЗнч(Рез)).Равно(Тип("Структура"));

	// Ключи верхнего уровня
	ЮТест.ОжидаетЧто(Рез.Свойство("КомпактнаяСтрока")).Равно(Истина);
	ЮТест.ОжидаетЧто(Рез.Свойство("Заголовок")).Равно(Истина);
	ЮТест.ОжидаетЧто(Рез.Свойство("Нагрузка")).Равно(Истина);
	ЮТест.ОжидаетЧто(Рез.Свойство("Утверждения")).Равно(Истина);

	Утв = Рез.Утверждения;
	ЮТест.ОжидаетЧто(ТипЗнч(Утв)).Равно(Тип("Структура"));

	// Все claims должны быть неопределены
	ЮТест.ОжидаетЧто(Утв.iss).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.aud).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.sub).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.jti).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.uid).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.act).Равно(Неопределено);
	ЮТест.ОжидаетЧто(Утв.exp).Равно(Неопределено);
КонецПроцедуры

Процедура JWT_Claims_ПолныйНабор_AudСтрока() Экспорт
	HeaderJSON = "{""alg"":""none"",""typ"":""JWT""}";
	PayloadJSON =
		"{"
		+ """iss"":""issuer-1"","
		+ """aud"":""aud-1"","
		+ """sub"":""subject-1"","
		+ """jti"":""id-1"","
		+ """uid"":""user-1"","
		+ """act"":""act-1"","
		+ """exp"":1700000000"
		+ "}";

	Компакт = СобратьJWT(HeaderJSON, PayloadJSON, "sig");

	Рез = JWT_Логика.РазобратьJWT(Компакт);
	Утв = Рез.Утверждения;

	ЮТест.ОжидаетЧто(Утв.iss).Равно("issuer-1");
	ЮТест.ОжидаетЧто(Утв.aud).Равно("aud-1");
	ЮТест.ОжидаетЧто(Утв.sub).Равно("subject-1");
	ЮТест.ОжидаетЧто(Утв.jti).Равно("id-1");
	ЮТест.ОжидаетЧто(Утв.uid).Равно("user-1");
	ЮТест.ОжидаетЧто(Утв.act).Равно("act-1");
	ЮТест.ОжидаетЧто(Утв.exp).Равно(1700000000);
КонецПроцедуры

Процедура JWT_Claims_ПолныйНабор_AudМассив() Экспорт
	HeaderJSON = "{""alg"":""none"",""typ"":""JWT""}";
	PayloadJSON =
		"{"
		+ """iss"":""issuer-1"","
		+ """aud"":[""aud-1"",""aud-2""],"
		+ """sub"":""subject-1"","
		+ """jti"":""id-1"","
		+ """uid"":""user-1"","
		+ """act"":""act-1"","
		+ """exp"":1700000000"
		+ "}";

	Компакт = СобратьJWT(HeaderJSON, PayloadJSON, "sig");

	Рез = JWT_Логика.РазобратьJWT(Компакт);
	Утв = Рез.Утверждения;

	ЮТест.ОжидаетЧто(ТипЗнч(Утв.aud)).Равно(Тип("Массив"));
	ЮТест.ОжидаетЧто(Утв.aud.Количество()).Равно(2);
	ЮТест.ОжидаетЧто(Утв.aud[0]).Равно("aud-1");
	ЮТест.ОжидаетЧто(Утв.aud[1]).Равно("aud-2");
КонецПроцедуры
