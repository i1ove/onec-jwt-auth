
Функция ВыполнитьСценарий(Знач ИдентификаторПользователяПриложения, Знач ТекущееВремяUTC, Знач Порты) Экспорт
	
	Эмитент = Порты.ПолитикаJWT.Эмитент();
	Получатели = Порты.ПолитикаJWT.Получатели();
	ВремяЖизниСек = Порты.ПолитикаJWT.ВремяЖизниСекунд();
	КлючСопоставления = Порты.ПолитикаJWT.КлючСопоставленияПользователяИБ_ДляJWT();
	ТипТокена = Порты.ПолитикаJWT.ТипТокена();
	
	Утверждения = Новый Структура;
	Утверждения.Вставить("uid", ИдентификаторПользователяПриложения);
	
	ИдентификаторТокена = Новый УникальныйИдентификатор;
	
	ДанныеТокена = Новый Структура;
	ДанныеТокена.Вставить("Эмитент", Эмитент);
	ДанныеТокена.Вставить("Получатели", Получатели);
	ДанныеТокена.Вставить("КлючСопоставленияПользователя", КлючСопоставления);
	ДанныеТокена.Вставить("ВремяСозданияUTC", ТекущееВремяUTC);
	ДанныеТокена.Вставить("ВремяЖизниСек", ВремяЖизниСек);
	ДанныеТокена.Вставить("ИдентификаторТокена", НРег(Строка(ИдентификаторТокена)));
	ДанныеТокена.Вставить("Утверждения", Утверждения);
	
	Токен = Порты.ПровайдерJWT.СформироватьJWT(ДанныеТокена, Порты.КлючПодписи);
	
	ДействуетДоUTC = ТекущееВремяUTC + ВремяЖизниСек;
	
	ХэшТокена = НРег(Строка(Порты.Криптография.SHA256Hex(Токен)));
	
	Порты.РегистрJWT.ЗаписатьСессию(ИдентификаторТокена, ИдентификаторПользователяПриложения, ДействуетДоUTC, ХэшТокена, Ложь, Порты.Пользователи);
	
	Результат = Новый Структура;
	Результат.Вставить("ТокенДоступа", Токен);
	Результат.Вставить("ТипТокена", ТипТокена);
	Результат.Вставить("СозданUTC", ТекущееВремяUTC);
	Результат.Вставить("ДействуетДоUTC", ДействуетДоUTC);
	Результат.Вставить("ВремяЖизниСек", ВремяЖизниСек);
	
	Возврат Результат;
	
КонецФункции
