
Функция ВыполнитьСценарий(Знач СтрокаPAT, Знач ВходАвторизации, Знач Порты) Экспорт
	СтрокаPAT = СокрЛП(СтрокаPAT);
	Если СтрДлина(СтрокаPAT) = 0 Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.НеАвторизован("Пустой PAT.", "API.Доступ.AUTHN.ПустойPAT", Доп);
	КонецЕсли;

	Попытка
		ДанныеPAT = PAT_Логика.РазобратьPAT(СтрокаPAT);
	Исключение
		Исх = ИнформацияОбОшибке();
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.НеАвторизован(
			"Некорректный PAT.",
			"API.Доступ.AUTHN.НекорректныйPAT",
			Доп,
			Исх
		);
	КонецПопытки;
	
	ИдентификаторТокена = ДанныеPAT.ИдентификаторТокена;
	Secret = ДанныеPAT.Secret; // lower-case hex

	ЗаписьPAT = Порты.РегистрPAT.ПолучитьPAT(ИдентификаторТокена, Порты.Пользователи);
	Если ЗаписьPAT = Неопределено Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		Доп.Вставить("ИдентификаторТокена", Строка(ИдентификаторТокена));
		ОшибкиПриложения.НеАвторизован("PAT не найден.", "API.Доступ.AUTHN.PATНеНайден", Доп);
	КонецЕсли;

	Если ЗаписьPAT.Отозван Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.НеАвторизован("PAT отозван.", "API.Доступ.AUTHN.PATОтозван", Доп);
	КонецЕсли;

	Если ЗаписьPAT.ДействуетДо < ВходАвторизации.ТекущееВремяUTC Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.НеАвторизован("Срок действия PAT истёк.", "API.Доступ.AUTHN.PATИстек", Доп);
	КонецЕсли;

	Если ЗаписьPAT.Алгоритм <> "SHA256-SALTHEX:SECRET" Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.ОшибкаКонфигурации(
			"Неподдерживаемый алгоритм PAT.",
			"API.Конфигурация.НеподдерживаемыйАлгоритмPAT",
			Доп
		);
	КонецЕсли;

	SaltHex = НРег(СокрЛП(ЗаписьPAT.СольHex));
	Если СтрДлина(SaltHex) = 0 Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.ОшибкаКонфигурации("PAT поврежден: нет соли.", "API.Конфигурация.PATНетСоли", Доп);
	КонецЕсли;

	Если Не PAT_Логика.ЭтоHexСтрока(SaltHex) Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.ОшибкаКонфигурации("PAT поврежден: некорректная соль.", "API.Конфигурация.PATСольНеHex", Доп);
	КонецЕсли;

	СтрокаХэширования = SaltHex + ":" + Secret;
	Попытка
		ХэшHex = НРег(Порты.Криптография.SHA256Hex(СтрокаХэширования));
	Исключение
		Исх = ИнформацияОбОшибке();
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.ОшибкаКонфигурации("Ошибка криптографии PAT.", "API.Конфигурация.КриптографияPAT", Доп, Исх);
	КонецПопытки;

	Если Не УтилитыСравнения.СравнитьКонстантно(НРег(ЗаписьPAT.ХэшHex), ХэшHex) Тогда
		Доп = ОшибкиПриложения.ДопИнфоДоступа(ВходАвторизации, "PAT");
		ОшибкиПриложения.НеАвторизован("Неверный PAT.", "API.Доступ.AUTHN.НеверныйPAT", Доп);
	КонецЕсли;
	
	Порты.РегистрPAT.ЗафиксироватьИспользование(ИдентификаторТокена, ВходАвторизации.ТекущееВремяUTC);

	Субъект = Новый Структура;
	Субъект.Вставить("Схема", "PAT");
	Субъект.Вставить("ИдентификаторПользователя", ЗаписьPAT.Пользователь);
	Субъект.Вставить("ИдентификаторТокена", ИдентификаторТокена);
	Субъект.Вставить("Утверждения", Новый Структура("pat_id", Строка(ИдентификаторТокена)));

	Возврат Субъект;
КонецФункции
