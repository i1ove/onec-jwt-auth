
Функция JSONВСтруктуру(Знач СтрокаJSON) Экспорт
	СтрокаJSON = СокрЛП(СтрокаJSON);
	Если СтрДлина(СтрокаJSON) = 0 Тогда
		ВызватьИсключение "Некорректный JSON: пустая строка.";
	КонецЕсли;

	Чтение = Новый ЧтениеJSON;
	Чтение.УстановитьСтроку(СтрокаJSON);

	Попытка
		Результат = ПрочитатьJSON(Чтение);
	Исключение
		ВызватьИсключение "Некорректный JSON: ошибка разбора.";
	КонецПопытки;

	Возврат Результат;
КонецФункции

Функция ВСтрокуJSON(Знач Значение) Экспорт
	Возврат ЗаписатьЗначениеJSON(Значение);
КонецФункции

Функция ПрочитатьСтроку(Знач Объект, Знач ИмяПоля, Знач Обязательное = Ложь) Экспорт
	Значение = Неопределено;

	Если ТипЗнч(Объект) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JSON: ожидался объект (Структура).";
	КонецЕсли;

	Если Не Объект.Свойство(ИмяПоля, Значение) Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: отсутствует обязательное поле '" + ИмяПоля + "'.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если Значение = Неопределено Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если ТипЗнч(Значение) <> Тип("Строка") Тогда
		ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' должно быть строкой.";
	КонецЕсли;

	Значение = СокрЛП(Значение);
	Если Обязательное И СтрДлина(Значение) = 0 Тогда
		ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
	КонецЕсли;

	Возврат Значение;
КонецФункции

Функция ПрочитатьЧисло(Знач Объект, Знач ИмяПоля, Знач Обязательное = Ложь) Экспорт
	Значение = Неопределено;

	Если ТипЗнч(Объект) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JSON: ожидался объект (Структура).";
	КонецЕсли;

	Если Не Объект.Свойство(ИмяПоля, Значение) Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: отсутствует обязательное поле '" + ИмяПоля + "'.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если Значение = Неопределено Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если ТипЗнч(Значение) <> Тип("Число") Тогда
		ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' должно быть числом.";
	КонецЕсли;

	Возврат Значение;
КонецФункции

Функция ПрочитатьБулево(Знач Объект, Знач ИмяПоля, Знач Обязательное = Ложь) Экспорт
	Значение = Неопределено;

	Если ТипЗнч(Объект) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JSON: ожидался объект (Структура).";
	КонецЕсли;

	Если Не Объект.Свойство(ИмяПоля, Значение) Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: отсутствует обязательное поле '" + ИмяПоля + "'.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если Значение = Неопределено Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если ТипЗнч(Значение) <> Тип("Булево") Тогда
		ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' должно быть булевым.";
	КонецЕсли;

	Возврат Значение;
КонецФункции

Функция ПрочитатьМассивСтрок(Знач Объект, Знач ИмяПоля, Знач Обязательное = Ложь) Экспорт
	
	Если ТипЗнч(Объект) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JSON: ожидался объект (Структура).";
	КонецЕсли;

	Значение = Неопределено;
	Если Не Объект.Свойство(ИмяПоля, Значение) Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: отсутствует обязательное поле '" + ИмяПоля + "'.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если Значение = Неопределено Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если ТипЗнч(Значение) <> Тип("Массив") И ТипЗнч(Значение) <> Тип("ФиксированныйМассив") Тогда
		ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' должно быть массивом строк.";
	КонецЕсли;

	Результат = Новый Массив;
	Для Каждого Элемент Из Значение Цикл
		Если ТипЗнч(Элемент) <> Тип("Строка") Тогда
			ВызватьИсключение "Некорректный JSON: массив '" + ИмяПоля + "' должен содержать строки.";
		КонецЕсли;
		Результат.Добавить(НРег(СокрЛП(Элемент)));
	КонецЦикла;

	Если Обязательное И Результат.Количество() = 0 Тогда
		ВызватьИсключение "Некорректный JSON: массив '" + ИмяПоля + "' пустой.";
	КонецЕсли;

	Возврат Результат;
КонецФункции

Функция ПрочитатьСтрокуИЛибоМассивСтрок(Знач Объект, Знач ИмяПоля, Знач Обязательное = Ложь) Экспорт
	Если ТипЗнч(Объект) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JSON: ожидался объект (Структура).";
	КонецЕсли;

	Значение = Неопределено;
	Если Не Объект.Свойство(ИмяПоля, Значение) Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: отсутствует обязательное поле '" + ИмяПоля + "'.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если Значение = Неопределено Тогда
		Если Обязательное Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;

	Если ТипЗнч(Значение) = Тип("Строка") Тогда
		Значение = СокрЛП(Значение);
		Если Обязательное И СтрДлина(Значение) = 0 Тогда
			ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' пустое.";
		КонецЕсли;
		Возврат Значение;
	КонецЕсли;

	Если ТипЗнч(Значение) = Тип("Массив") ИЛИ ТипЗнч(Значение) = Тип("ФиксированныйМассив") Тогда
		Возврат ПрочитатьМассивСтрок(Объект, ИмяПоля, Обязательное);
	КонецЕсли;

	ВызватьИсключение "Некорректный JSON: поле '" + ИмяПоля + "' должно быть строкой или массивом строк.";
КонецФункции
