
Функция ОтветJSON(Знач КодHTTP, Знач Тело, Знач Корреляция, Знач ДопЗаголовки = Неопределено) Экспорт
	Если КодHTTP = Неопределено Тогда
		КодHTTP = 200;
	КонецЕсли;
	
	Ответ = НовыйОтветJSON(КодHTTP, Корреляция, ДопЗаголовки);
	
	Если КодHTTP = 204 Или КодHTTP = 304 Тогда
		Возврат Ответ;
	КонецЕсли;
	
	Если Тело = Неопределено Тогда
		Тело = Новый Структура; // чтобы клиент всегда получал валидный JSON
	КонецЕсли;
	
	Ответ.УстановитьТелоИзСтроки(УтилитыJSON.ВСтрокуJSON(Тело), КодировкаТекста.UTF8);
	Возврат Ответ;
КонецФункции

Функция ОтветОшибки(Знач КодHTTP, Знач КодОшибки, Знач Сообщение, Знач Корреляция, Знач Детали = Неопределено) Экспорт
	Если КодHTTP = Неопределено Тогда
		КодHTTP = 500;
	КонецЕсли;
	
	КодОш = ?(КодОшибки = Неопределено Или Строка(КодОшибки) = "", "internal_error", Строка(КодОшибки));
	Сообщ = ?(Сообщение = Неопределено Или Строка(Сообщение) = "", "Внутренняя ошибка.", Строка(Сообщение));
	
	СтрОшибка = Новый Структура;
	СтрОшибка.Вставить("сообщение", Сообщ);
	СтрОшибка.Вставить("код", КодОш);
	СтрОшибка.Вставить("корреляция", HTTPПротоколAPI.НормализоватьUUID(Корреляция));
	
	Если Детали <> Неопределено Тогда
		СтрОшибка.Вставить("детали", Детали);
	КонецЕсли;
	
	Тело = Новый Структура;
	Тело.Вставить("ошибка", СтрОшибка);
	
	Ответ = НовыйОтветJSON(КодHTTP, Корреляция, Неопределено);
	Ответ.УстановитьТелоИзСтроки(УтилитыJSON.ВСтрокуJSON(Тело), КодировкаТекста.UTF8);
	
	Возврат Ответ;
КонецФункции

Функция НовыйОтветJSON(Знач КодHTTP, Знач Корреляция, Знач ДопЗаголовки)
	Ответ = Новый HTTPСервисОтвет(КодHTTP);
	
	// стандартные заголовки
	Для Каждого П Из СтандартныеЗаголовкиJSON() Цикл
		Ответ.Заголовки.Вставить(П.Ключ, П.Значение);
	КонецЦикла;
	
	// корреляция
	Корр = HTTPПротоколAPI.НормализоватьUUID(Корреляция);
	Если СтрДлина(Корр) > 0 Тогда
		Ответ.Заголовки.Вставить("X-Correlation-Id", Корр);
	КонецЕсли;
	
	// доп. заголовки (если есть)
	Если ТипЗнч(ДопЗаголовки) = Тип("Структура")
		Или ТипЗнч(ДопЗаголовки) = Тип("Соответствие") Тогда
		Для Каждого П Из ДопЗаголовки Цикл
			Имя = СокрЛП(Строка(П.Ключ));
			Если Имя = "" Тогда
				Продолжить;
			КонецЕсли;
			
			// не даём ломать Content-Type изнаружи (для JSON-ответчика это правильно)
			Если НРег(Имя) = НРег("Content-Type") Тогда
				Продолжить;
			КонецЕсли;
			
			Ответ.Заголовки.Вставить(Имя, ОчиститьЗначениеЗаголовка(П.Значение, 1024));
		КонецЦикла;
	КонецЕсли;
	
	Возврат Ответ;
КонецФункции

Функция СтандартныеЗаголовкиJSON()
	З = Новый Соответствие;
	З.Вставить("Content-Type", "application/json; charset=utf-8");
	З.Вставить("Cache-Control", "no-store");
	З.Вставить("Pragma", "no-cache");
	З.Вставить("X-Content-Type-Options", "nosniff");
	Возврат З;
КонецФункции

Функция ОчиститьЗначениеЗаголовка(Знач Значение, Знач МаксДлина)
	Если Значение = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	Т = Строка(Значение);
	
	Т = СтрЗаменить(Т, Символы.ПС, "");
	Т = СтрЗаменить(Т, Символы.ВК, "");
	Т = СтрЗаменить(Т, Символ(9), "");
	
	Т = СокрЛП(Т);
	
	Если МаксДлина > 0 И СтрДлина(Т) > МаксДлина Тогда
		Т = Лев(Т, МаксДлина);
	КонецЕсли;
	
	Возврат Т;
КонецФункции
