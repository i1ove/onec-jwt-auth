
Функция Base64ДекодироватьВДвоичныеДанные(Знач СтрокаBase64) Экспорт
	СтрокаBase64 = СокрЛП(СтрокаBase64);
	Если СтрДлина(СтрокаBase64) = 0 Тогда
		ВызватьИсключение "Некорректная Base64-строка: пустое значение.";
	КонецЕсли;

	Попытка
		Возврат Base64Значение(СтрокаBase64);
	Исключение
		ВызватьИсключение "Некорректная Base64-строка.";
	КонецПопытки;
КонецФункции

Функция Base64ДекодироватьВСтроку(Знач СтрокаBase64, Знач Кодировка = Неопределено) Экспорт
	Если Кодировка = Неопределено Тогда
		Кодировка = КодировкаТекста.UTF8;
	КонецЕсли;
	
	Двоичные = Base64ДекодироватьВДвоичныеДанные(СтрокаBase64);

	Попытка
		Возврат ПолучитьСтрокуИзДвоичныхДанных(Двоичные, Кодировка);
	Исключение
		ВызватьИсключение "Не удалось преобразовать Base64 в строку (ошибка кодировки).";
	КонецПопытки;
КонецФункции

Функция Base64UrlДекодироватьВДвоичныеДанные(Знач СтрокаBase64Url) Экспорт
	СтрокаBase64 = ПреобразоватьBase64UrlВBase64(СтрокаBase64Url);
	Возврат Base64ДекодироватьВДвоичныеДанные(СтрокаBase64);
КонецФункции

Функция Base64UrlДекодироватьВСтроку(Знач СтрокаBase64Url, Знач Кодировка = Неопределено) Экспорт
	Если Кодировка = Неопределено Тогда
		Кодировка = КодировкаТекста.UTF8;
	КонецЕсли;
	
	СтрокаBase64 = ПреобразоватьBase64UrlВBase64(СтрокаBase64Url);
	Возврат Base64ДекодироватьВСтроку(СтрокаBase64, Кодировка);
КонецФункции

Функция ПреобразоватьBase64UrlВBase64(Знач СтрокаBase64Url) Экспорт
	СтрокаBase64Url = СокрЛП(СтрокаBase64Url);
	Если СтрДлина(СтрокаBase64Url) = 0 Тогда
		ВызватьИсключение "Некорректная Base64Url-строка: пустое значение.";
	КонецЕсли;

	Результат = СтрЗаменить(СтрокаBase64Url, "-", "+");
	Результат = СтрЗаменить(Результат, "_", "/");

	// Base64Url обычно без padding, добавим '=' до кратности 4
	Остаток = СтрДлина(Результат) % 4;
	Если Остаток = 2 Тогда
		Результат = Результат + "==";
	ИначеЕсли Остаток = 3 Тогда
		Результат = Результат + "=";
	ИначеЕсли Остаток = 1 Тогда
		ВызватьИсключение "Некорректная Base64Url-строка: неверная длина.";
	КонецЕсли;

	Возврат Результат;
КонецФункции
