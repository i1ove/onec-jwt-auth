
// Назначение: сгенерировать PAT (pat.<uuid>.<secret>) и записать только salt+hash в регистр.
// Важно: secret нигде не сохраняется и не логируется.

Функция ВыполнитьСценарий(Знач ИдентификаторПользователя, Знач ДействуетДоUTC, Знач ТекущееВремяUTC, Знач Описание, Знач Порты) Экспорт
	
	Если ДействуетДоUTC <= ТекущееВремяUTC Тогда
		ОшибкиПриложения.ОшибкаДанных(
			"'Действует до' должно быть позже текущего времени.",
			"UI.PAT.BAD_INPUT.EXP_IN_PAST",
			Новый Структура("ДействуетДоUTC,ТекущееВремяUTC", ДействуетДоUTC, ТекущееВремяUTC)
		);
	КонецЕсли;
	
	Описание = СокрЛП(Описание);
	Если СтрДлина(Описание) = 0 Тогда
		Описание = "PAT";
	КонецЕсли;
	
	Алгоритм = "SHA256-SALTHEX:SECRET";
	
	ИдентификаторТокена = Новый УникальныйИдентификатор;
	
	// Генерим secret и salt через уже существующую криптографию (SHA256Hex)
	SecretHex = СгенерироватьSecretHex_(Порты.Криптография, ТекущееВремяUTC);
	SaltHex   = СгенерироватьSaltHex32_(Порты.Криптография, ТекущееВремяUTC); // 32 hex (как в регистре из конфигурации)
	
	СтрокаХэширования = SaltHex + ":" + SecretHex;
	
	ХэшHex = НРег(Порты.Криптография.SHA256Hex(СтрокаХэширования));
	
	ЗаписьPAT = Новый Структура;
	ЗаписьPAT.Вставить("ИдентификаторТокена", ИдентификаторТокена);
	ЗаписьPAT.Вставить("Пользователь", ИдентификаторПользователя); // домен: UUID
	ЗаписьPAT.Вставить("ХэшHex", ХэшHex);
	ЗаписьPAT.Вставить("СольHex", SaltHex);
	ЗаписьPAT.Вставить("Алгоритм", Алгоритм);
	ЗаписьPAT.Вставить("ДействуетДо", ДействуетДоUTC);
	ЗаписьPAT.Вставить("Отозван", Ложь);
	ЗаписьPAT.Вставить("Создан", ТекущееВремяUTC);
	ЗаписьPAT.Вставить("ПоследнееИспользование", Неопределено);
	ЗаписьPAT.Вставить("Описание", Описание);
	
	// В регистр уходит только запись (salt+hash и мета); secret нигде не сохраняется
	Порты.РегистрPAT.СоздатьPAT(ЗаписьPAT, Порты.Пользователи);
	
	СтрокаPAT = "pat." + НРег(Строка(ИдентификаторТокена)) + "." + SecretHex;
	
	Результат = Новый Структура;
	Результат.Вставить("PAT", СтрокаPAT);
	Результат.Вставить("ИдентификаторТокена", ИдентификаторТокена);
	Результат.Вставить("ДействуетДо", ДействуетДоUTC);
	Результат.Вставить("Создан", ТекущееВремяUTC);
	
	Возврат Результат;
		
КонецФункции

Функция СгенерироватьSecretHex_(Знач Криптография, Знач ВремяUTC)
	Сид = Строка(Новый УникальныйИдентификатор) + ":"
		+ Строка(Новый УникальныйИдентификатор) + ":"
		+ Формат(ВремяUTC, "ДФ=yyyyMMddHHmmssfff");
	
	Возврат НРег(Криптография.SHA256Hex(Сид)); // 64 hex
КонецФункции

Функция СгенерироватьSaltHex32_(Знач Криптография, Знач ВремяUTC)
	Сид = Строка(Новый УникальныйИдентификатор) + ":"
		+ Формат(ВремяUTC, "ДФ=yyyyMMddHHmmssfff");
	
	Полный = НРег(Криптография.SHA256Hex(Сид)); // 64 hex
	
	Возврат Лев(Полный, 32); // 32 hex (под ресурс Соль длиной 32)
КонецФункции
