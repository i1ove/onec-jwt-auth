
// Возвращает Структура:
//  "КодHTTP"      (Число)
//  "КодОшибки"    (Строка)    // Инфо.Код или fallback
//  "Сообщение"    (Строка)    // безопасное сообщение наружу
//  "Детали"       (Любой)     // опционально, по умолчанию Неопределено
Функция ИзИсключения(Знач Инфо, Знач ВходАвторизации = Неопределено, Знач Корреляция = "") Экспорт
	КодОшибки = ПолучитьКодОшибкиБезПадения(Инфо);
	
	// 1) Основной путь
	КодHTTP = КодHTTPПоКодуИлиКатегорииОшибки(КодОшибки, Инфо, ВходАвторизации);
	
	// 2) Сообщение наружу — безопасное (не раскрываем внутренности)
	Сообщение = СообщениеНаружу(КодОшибки, Инфо, КодHTTP);
	
	// 3) Детали по умолчанию не отдаем (можно включить для 400/422 в будущем)
	Детали = Неопределено;
	
	// 4) Fallback если кода нет совсем
	Если СтрДлина(СокрЛП(КодОшибки)) = 0 Тогда
		КодОшибки = "internal_error";
	КонецЕсли;
	
	Результат = Новый Структура;
	Результат.Вставить("КодHTTP", КодHTTP);
	Результат.Вставить("КодОшибки", КодОшибки);
	Результат.Вставить("Сообщение", Сообщение);
	Результат.Вставить("Детали", Детали);
	
	Возврат Результат;
КонецФункции

Функция КодHTTPПоКодуИлиКатегорииОшибки(Знач Код, Знач Инфо, Знач ВходАвторизации)
	Если СтрДлина(СокрЛП(Код)) > 0 Тогда
		Если НачинаетсяС(Код, "API.Доступ.AUTHN") Тогда
			Возврат 401;
		ИначеЕсли НачинаетсяС(Код, "API.Доступ.AUTHZ") Тогда
			Возврат 403;
		ИначеЕсли НачинаетсяС(Код, "API.Данные") ИЛИ НачинаетсяС(Код, "HTTP.REQUEST.VALIDATION") Тогда
			Возврат 400;
		ИначеЕсли НачинаетсяС(Код, "API.Конфигурация") Или НачинаетсяС(Код, "API.Инфраструктура") Тогда
			Возврат 500;
		КонецЕсли;
		
		// неизвестный ваш код — пусть будет 500
		Возврат 500;
	КонецЕсли;
	
	// fallback по категориям платформы
	Возврат КодHTTPПоКатегории(Инфо, ВходАвторизации);
КонецФункции

Функция КодHTTPПоКатегории(Знач Инфо, Знач ВходАвторизации)
	Если ЭтоОшибкаКатегории(Инфо, КатегорияОшибки.НарушениеПравДоступа) Тогда
		// Важно: определяем 401 vs 403 по наличию Authorization
		Если ЕстьАвторизация(ВходАвторизации) Тогда
			Возврат 403;
		Иначе
			Возврат 401;
		КонецЕсли;
	КонецЕсли;
	
	Если ЭтоОшибкаКатегории(Инфо, КатегорияОшибки.НеправильныйПароль) Тогда
		Возврат 401;
	КонецЕсли;
	
	Если ЭтоОшибкаКатегории(Инфо, КатегорияОшибки.ОтсутствиеРазрешенияДляИспользованияФункциональности) Тогда
		Возврат 403;
	КонецЕсли;
	
	Если ЭтоОшибкаКатегории(Инфо, КатегорияОшибки.НеподдерживаемыйФормат) Тогда
		Возврат 400;
	КонецЕсли;
	
	Возврат 500;
КонецФункции

Функция СообщениеНаружу(Знач КодОшибки, Знач Инфо, Знач КодHTTP)
	Если СтрДлина(СокрЛП(КодОшибки)) > 0 Тогда
		Если НачинаетсяС(КодОшибки, "API.Доступ.AUTHN") Тогда
			Возврат "Не авторизован.";
		ИначеЕсли НачинаетсяС(КодОшибки, "API.Доступ.AUTHZ") Тогда
			Возврат "Доступ запрещен.";
		ИначеЕсли НачинаетсяС(КодОшибки, "API.Данные") ИЛИ НачинаетсяС(КодОшибки, "HTTP.REQUEST.VALIDATION") Тогда
			Возврат "Некорректные входные данные.";
		КонецЕсли;
		
		Возврат "Внутренняя ошибка.";
	КонецЕсли;
	
	Если КодHTTP = 401 Тогда
		Возврат "Не авторизован.";
	ИначеЕсли КодHTTP = 403 Тогда
		Возврат "Доступ запрещен.";
	ИначеЕсли КодHTTP = 400 Тогда
		Возврат "Некорректные входные данные.";
	КонецЕсли;
	
	Возврат "Внутренняя ошибка.";
	
КонецФункции

Функция ПолучитьКодОшибкиБезПадения(Знач Инфо)
	Попытка
		Если Инфо <> Неопределено И Инфо.Код <> Неопределено Тогда
			Возврат Строка(Инфо.Код);
		КонецЕсли;
	Исключение
		// ничего
	КонецПопытки;
	
	Возврат "";
КонецФункции

Функция ЭтоОшибкаКатегории(Знач Инфо, Знач Категория)
	Попытка
		Возврат Инфо <> Неопределено И Инфо.ЯвляетсяОшибкойКатегории(Категория);
	Исключение
		Возврат Ложь;
	КонецПопытки;
КонецФункции

Функция ЕстьАвторизация(Знач ВходАвторизации)
	Если ВходАвторизации = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ТипЗнч(ВходАвторизации) <> Тип("Структура") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если НЕ ВходАвторизации.Свойство("СтрокаАвторизации") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат СтрДлина(СокрЛП(Строка(ВходАвторизации.СтрокаАвторизации))) > 0;
КонецФункции

Функция НачинаетсяС(Знач Текст, Знач Префикс)
	Если Текст = Неопределено Тогда Возврат Ложь; КонецЕсли;
	Если Префикс = Неопределено Тогда Возврат Ложь; КонецЕсли;
	
	Т = Строка(Текст);
	П = Строка(Префикс);
	
	Если СтрДлина(П) = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Лев(Т, СтрДлина(П)) = П;
КонецФункции
