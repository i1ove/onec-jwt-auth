
Процедура ЗаписатьИсключениеВЖурналРегистрации(Знач Инфо, Знач Корреляция, Знач ВходАвторизации = Неопределено, Знач КодHTTP = 0) Экспорт
	// логирование не должно рушить ответ
	Попытка
		КодОшибки = "";
		Попытка КодОшибки = СокрЛП(Строка(Инфо.Код)); 
		Исключение 
		КонецПопытки;

		Уровень = ОпределитьУровеньЖурнала(КодОшибки);

		// Контекст запроса
		Операция = "";
		Транспорт = "";
		Схема = "";
		Если ТипЗнч(ВходАвторизации) = Тип("Структура") Тогда
			Если ВходАвторизации.Свойство("Операция") Тогда
				Операция = Строка(ВходАвторизации.Операция);
			КонецЕсли;
			Если ВходАвторизации.Свойство("Транспорт") Тогда
				Транспорт = Строка(ВходАвторизации.Транспорт);
			КонецЕсли;
		КонецЕсли;

		ДопИнфо = Неопределено;
		Попытка ДопИнфо = Инфо.ДополнительнаяИнформация;
		Исключение
		КонецПопытки;

		Подробно = "";
		Попытка
			Подробно = ПодробноеПредставлениеОшибкиСПричинами(Инфо);
		Исключение
			Подробно = ОписаниеОшибки();
		КонецПопытки;

		// Собираем комментарий: контекст + допинфо + подробная ошибка
		Комментарий = СформироватьКомментарий(Корреляция, КодHTTP, КодОшибки, Операция, Транспорт, ДопИнфо, Подробно);

		// Страховка от утечек: санитизируем уже конечный комментарий
		Комментарий = УтилитыСанитайзера.СанитизироватьСтроку(Комментарий, 16000);

		// Пишем в журнал регистрации.
		// <ОбъектМетаданных> — фиксируем общий модуль пайплайна, чтобы удобно отбирать.
		ЗаписьЖурналаРегистрации(
			НСтр("ru='HTTP API'"),
			Уровень,
			Метаданные.ОбщиеМодули.ПайплайнAPI,
			,
			Комментарий,
			РежимТранзакцииЗаписиЖурналаРегистрации.Независимая
		);

	Исключение
		// молча
	КонецПопытки;
КонецПроцедуры

Функция ПодробноеПредставлениеОшибкиСПричинами(Инфо, МаксимумУровней = 10)
	Если Инфо = Неопределено Тогда
		Возврат "";
	КонецЕсли;

	Текст = "";
	Текущая = Инфо;

	// Для защиты от циклов (на всякий случай)
	УжеБыли = Новый Массив;

	Для НомерУровня = 0 По МаксимумУровней - 1 Цикл
		
		Если Текущая = Неопределено Тогда
			Прервать;
		КонецЕсли;

		// Защита от цикла: если тот же объект уже встречался — прекращаем
		Если УжеБыли.Найти(Текущая) <> Неопределено Тогда
			Текст = Текст + "Причина: (обнаружен цикл причин, дальнейший вывод прекращён)" + Символы.ПС;
			Прервать;
		КонецЕсли;
		УжеБыли.Добавить(Текущая);

		Если НомерУровня = 0 Тогда
			Заголовок = "Ошибка";
		Иначе
			Заголовок = "Причина #" + Строка(НомерУровня);
		КонецЕсли;

		Текст = Текст
			+ Заголовок + ":" + Символы.ПС
			+ ОбработкаОшибок.ПодробноеПредставлениеОшибки(Текущая) + Символы.ПС;

		// (Опционально) добьем “мета-поля” отдельной строкой, чтобы было удобно глазами/поиском
		Текст = Текст + "Код=" + ПолучитьКодОшибкиБезПадения(Текущая)
			+ "; Категория=" + ПолучитьКатегориюОшибкиБезПадения(Текущая)
			+ Символы.ПС;

		// Следующая причина
		Следующая = ПолучитьПричинуБезПадения(Текущая);
		Если Следующая = Неопределено Тогда
			Прервать;
		КонецЕсли;

		Текущая = Следующая;
		Текст = Текст + Символы.ПС;
	КонецЦикла;

	Возврат Текст;
КонецФункции

Функция ПолучитьПричинуБезПадения(Инфо)
	Причина = Неопределено;
	Попытка
		Причина = Инфо.Причина;
	Исключение
		// Ничего: у некоторых исключений/версий может не быть свойства
	КонецПопытки;

	Возврат Причина;
КонецФункции


Функция ПолучитьКодОшибкиБезПадения(Инфо)
	Код = "";
	Попытка
		Если Инфо.Код <> Неопределено Тогда
			Код = Строка(Инфо.Код);
		КонецЕсли;
	Исключение
		// игнор
	КонецПопытки;

	Возврат Код;
КонецФункции


Функция ПолучитьКатегориюОшибкиБезПадения(Инфо)
	Кат = "";
	Попытка
		Если Инфо.Категория <> Неопределено Тогда
			Кат = Строка(Инфо.Категория);
		КонецЕсли;
	Исключение
		// игнор
	КонецПопытки;

	Возврат Кат;
КонецФункции

Функция ОпределитьУровеньЖурнала(Знач КодОшибки)
	КодОшибки = СокрЛП(Строка(КодОшибки));

	Если Лев(КодОшибки, 16) = "API.Доступ.AUTHN" Тогда
		Возврат УровеньЖурналаРегистрации.Предупреждение;
	ИначеЕсли Лев(КодОшибки, 16) = "API.Доступ.AUTHZ" Тогда
		Возврат УровеньЖурналаРегистрации.Информация;
	Иначе
		Возврат УровеньЖурналаРегистрации.Ошибка;
	КонецЕсли;
КонецФункции

Функция СформироватьКомментарий(Знач Корреляция, Знач КодHTTP, Знач КодОшибки, Знач Операция, Знач Транспорт, Знач ДопИнфо, Знач Подробно)
	Текст = "";

	Текст = Текст + "корреляция=" + Строка(Корреляция) + Символы.ПС;
	Если КодHTTP <> 0 Тогда
		Текст = Текст + "http=" + Строка(КодHTTP) + Символы.ПС;
	КонецЕсли;
	Если СтрДлина(СокрЛП(КодОшибки)) > 0 Тогда
		Текст = Текст + "код=" + КодОшибки + Символы.ПС;
	КонецЕсли;
	Если СтрДлина(СокрЛП(Операция)) > 0 Тогда
		Текст = Текст + "операция=" + Операция + Символы.ПС;
	КонецЕсли;
	Если СтрДлина(СокрЛП(Транспорт)) > 0 Тогда
		Текст = Текст + "транспорт=" + Транспорт + Символы.ПС;
	КонецЕсли;

	Если ДопИнфо <> Неопределено Тогда
		Текст = Текст + "контекст=" + ПредставлениеДопИнфо(ДопИнфо) + Символы.ПС;
	КонецЕсли;

	Текст = Текст + "ошибка:" + Символы.ПС + Подробно;

	Возврат Текст;
КонецФункции

Функция ПредставлениеДопИнфо(Знач ДопИнфо)
	// Кладём в комментарий “плоско”, без секрета. Санитизация будет после.
	Если ТипЗнч(ДопИнфо) <> Тип("Структура") Тогда
		Возврат Строка(ДопИнфо);
	КонецЕсли;

	Рез = "";
	Для Каждого П Из ДопИнфо Цикл
		Если СтрДлина(Рез) > 0 Тогда
			Рез = Рез + "; ";
		КонецЕсли;
		Рез = Рез + П.Ключ + "=" + Строка(П.Значение);
	КонецЦикла;

	Возврат Рез;
КонецФункции
