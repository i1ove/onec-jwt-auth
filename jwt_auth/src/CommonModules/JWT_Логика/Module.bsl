
// Без I/O: только разбор compact JWT и извлечение нужных полей.

Функция РазобратьJWT(Знач КомпактJWTСтрока) Экспорт
	КомпактJWTСтрока = СокрЛП(КомпактJWTСтрока);
	Если СтрДлина(КомпактJWTСтрока) = 0 Тогда
		ВызватьИсключение "Некорректный JWT: пустая строка.";
	КонецЕсли;

	Части = СтрРазделить(КомпактJWTСтрока, ".", Истина);
	Если Части.Количество() <> 3 Тогда
		ВызватьИсключение "Некорректный JWT: ожидались 3 части (header.payload.signature).";
	КонецЕсли;

	Если СтрДлина(Части[0]) = 0 Или СтрДлина(Части[1]) = 0 Или СтрДлина(Части[2]) = 0 Тогда
		ВызватьИсключение "Некорректный JWT: пустая часть.";
	КонецЕсли;

	СтрокаHeaderJSON = УтилитыКодирования.Base64UrlДекодироватьВСтроку(Части[0], КодировкаТекста.UTF8);
	СтрокаPayloadJSON = УтилитыКодирования.Base64UrlДекодироватьВСтроку(Части[1], КодировкаТекста.UTF8);

	Header = УтилитыJSON.JSONВСтруктуру(СтрокаHeaderJSON);
	Payload = УтилитыJSON.JSONВСтруктуру(СтрокаPayloadJSON);

	Если ТипЗнч(Header) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JWT: header должен быть JSON-объектом.";
	КонецЕсли;
	Если ТипЗнч(Payload) <> Тип("Структура") Тогда
		ВызватьИсключение "Некорректный JWT: payload должен быть JSON-объектом.";
	КонецЕсли;

	Утверждения = Новый Структура;
	Утверждения.Вставить("iss", УтилитыJSON.ПрочитатьСтроку(Payload, "iss", Ложь));
	Утверждения.Вставить("aud", УтилитыJSON.ПрочитатьСтрокуИЛибоМассивСтрок(Payload, "aud", Ложь));
	Утверждения.Вставить("sub", УтилитыJSON.ПрочитатьСтроку(Payload, "sub", Ложь));
	Утверждения.Вставить("jti", УтилитыJSON.ПрочитатьСтроку(Payload, "jti", Ложь));
	Утверждения.Вставить("uid", УтилитыJSON.ПрочитатьСтроку(Payload, "uid", Ложь));
	Утверждения.Вставить("act", УтилитыJSON.ПрочитатьСтроку(Payload, "act", Ложь));
	Утверждения.Вставить("exp", УтилитыJSON.ПрочитатьЧисло(Payload, "exp", Ложь));

	Возврат Новый Структура(
		"КомпактнаяСтрока,Заголовок,Нагрузка,Утверждения",
		КомпактJWTСтрока, Header, Payload, Утверждения
	);
КонецФункции
